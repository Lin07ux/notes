> 转摘：[吃透 FTP](https://mp.weixin.qq.com/s/WVUskIButrTstlq508xw8g)

FTP，即文件传输协议(File Transfer Protocol)，是一种仍然活跃的客户端-服务端之间的传输协议。

FTP 协议会用到两条连接，分别用于传输指令的**命令通道**和传输数据的**数据通道**。需要注意的是数据通道一开始并不会建立，只有在涉及数据传输时才会临时建立。

根据是否由服务器端主动建立数据传输通道，将 FTP 分成了两种工作模式：主动模式和被动模式。目前绝大多数 FTP 服务器均采用了被动模式，但是在某些场景下还是需要使用主动模式。

### 1. 主动模式

主动模式下的工作流程图如下所示：

![](http://cnd.qiniu.lin07ux.cn/markdown/1578474775412.png)

其中：

1. 客户端随机选取一个端口 X，通过 TCP 向服务器的 21 端口（默认端口，可以更改）发送请求，建立命令通道。命令通道一旦建立，后续无论上传、下载等其他操作指令，都会首先通过命令通道来传输。当然建立命令通道的过程中，必然少不了 TCP 的三次握手。
2. 当涉及上传、下载等操作时，客户端会再次随机一个端口 Y，通过命令通道通知服务器，请求建立数据通道。数据通道用于实际的数据传输，不涉及命令传输。
3. 服务器收到通知后，通过 20 端口（默认端口）主动连接客户端的端口 Y，此时数据通道正式建立，客户端与服务器开始传输实际数据。

可以看到，主动模式下，是由 FTP 服务器主动向客户端提供的端口进行数据通道的建立。

### 2. 被动模式

相应的，被动模式是由客户端主动向 FTP 服务器建立数据通道，流程图如下所示：

![](http://cnd.qiniu.lin07ux.cn/markdown/1578475019698.png)

其中：

1. 客户端随机选取一个端口 X，通过 TCP 向服务器 21 端口发送请求，建立命令通道。
2. 当涉及上传、下载等操作时，客户端通过命令通道通知服务器，请求建立数据通道。此时，被动模式下客户端并没有随机选择一个端口通知服务器。
3. 服务器收到建立数据通道的命令后，会随机一个自身端口 Z，继续通过命令通道将端口 Z 告诉给客户端。
4. 客户端通过随机一个自身端口 Y，主动连接服务器端口 Z。此时数据通道才正式建立。

### 3. 为什么需要区分主动模式和被动模式？

既然主动模式或者被动模式下 FTP 都能工作，为什么还要进行模式区分呢？

这是因为现实世界中，客户端同服务器之间往往存在防火墙或局域网。

主动模式下，当客户端位于防火墙之后时，当客户端请求建立数据通道时，服务器将会主动连接防火墙的端口 Y，而不是客户端的端口 Y，数据通道建立失败。此时表现为看似客户端已经连接服务器，但是无法传输数据。这就需要使用被动模式来解决。

同样的，当服务器隐藏在防火墙背后时，被动模式就无法建立数据通道，而需要改用主动模式了。

当客户端和服务器端分别位于各自的防火墙之下时，主动模式和被动模式就都失效了，都无法正常的建立数据通道。

不同模式适用的场景如下图所示：

![](http://cnd.qiniu.lin07ux.cn/markdown/1578475378428.png)



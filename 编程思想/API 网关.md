在进行系统微服务化时，通常会搭配 API 网关进行使用。

> 转摘：
> 
> 1. [使用 API 网关构建微服务](https://www.infoq.cn/article/construct-micro-service-using-api-gateway/)
> 2. [这样讲 API 网关，你应该能明白了吧](https://mp.weixin.qq.com/s/7m2uZGROUFHaCreXvLDswQ)

## 一、API 网关介绍

在使用 API 网关之前，需要对 API 网关是什么、为什么要使用、有什么优缺点等有相关的了解。

### 1.1 什么是 API 网关

网关一词最早是指一种网络设备，比如两个相互独立的局域网之间通过路由器进行通信，中间的路由就被称为网关。

任何一个应用系统如果需要被其他系统调用，就需要博爱路 API，这些 API 代表着一个个的功能点。如果在两个需要通信的系统中间加上一个中介者协助 API 的调用，这个中介者就是 API 网关。当然，API 网关也能够放在客户端与服务器端之间。如下图所示

![](http://cnd.qiniu.lin07ux.cn/markdown/1572919138825.png)

### 1.2 为什么要用 API 网关

为了提高系统的性能和可靠性，将应用服务进行拆分而微服务化是一个理想选择。当选择将应用程序构建为一组微服务时，需要确定应用程序客户端如何与微服务交互。在单体应用程序中，只有一组(通常是重复的、负载均衡的)端点。然而，在微服务架构中，每个微服务都会暴露一组通常是细粒度的端点，如果直接将各个微服务对外开放，会造成 API 难以管理和使用的问题。

比如，对于一个电商平台，其系统已经实现微服务化，每个 API 节点只负责一个特定的功能。当用户访问平台商品的详情页的时候，页面上不仅需要包含基本的产品信息(如名称、描述、价格等)，还需要展示更多的附加信息，如：

* 购物车中的件数
* 订单历史
* 客户评论
* 低库存预警
* 送货选项
* 各种推荐，包括经常与该产品一起购买的其它产品，购买该产品的客户购买的其它产品，购买该产品的客户看过的其它产品。
* 可选的购买选项。

这些信息分别由不同的微服务提供支持，那么客户端为了完整的展示产品信息，就需要逐一的向这些微服务发送请求。当需要的微服务越多的时候，就需要发送越多的请求。对于大型的系统(如 Amazon、淘宝)来说，一个页面可能就需要调用上百个服务。但是在公网中一次发送这么多请求是很低效的，在移动网络中就更会遇到问题。

另外，这样方法还使得客户端的代码非常复杂，需要与后端微服务的开发紧密结合，使得微服务难以重构，因为一旦微服务出现变动，就需要更新客户端的相关代码，如 APP 升级等。

客户端直接调用微服务的另一个问题是，不是所有的微服务使用的协议都是 Web 友好协议。一个服务可能使用 Thrift 二进制 RPC，而另一个服务可能使用 AMQP 消息传递协议。不管哪种协议都不是浏览器友好或防火墙友好的，最好是内部使用。在防火墙之外，应用程序应该使用诸如 HTTP 和 WebSocket 之类的协议。

由于这些问题的存证，客户端与微服务直接通信很少的合理的。而一个更好的方法就是使用所谓的 API 网关。

API 网关是一个服务器，是系统的唯一入口。从面向对象设计的角度看，它与外观模式类似。API 网关封装了系统内部架构，为每个客户端提供了一个定制的 API，避免了客户端需要自行处理各个微服务数据的问题。使用 API 网关后，从客户端的角度来看，整个系统还是一个单体系统，相对来说客户端的操作就会简单很多了。

使用 API 网关之后，客户端的请求流程如下图所示：

![](http://cnd.qiniu.lin07ux.cn/markdown/1572920283207.png)

### 1.3 API 网关的作用(优点)

API 网关作为系统的唯一入口，那么进入系统的所有请求都需要经过它。这就可以方便在 API 网关中做一些统一的操作，比如：

* 身份验证
* 访问控制
* 请求路由
* 协议转换
* 负载均衡
* 流量控制
* 缓存
* 日志管理

由 API 网关统一处理这些通用的功能，能够简化各个微服务的开发迭代。比如，由于 API 网关统一进行协议转换，那么微服务可以使用最适合的协议生成数据，而客户端依旧可以得到想要的格式的数据。

通常，API 网关会向客户端暴露一个粗粒度的 API。比如在产品详情页的场景中，API 网关可以提供一个端点，使客户端可以通过一个请求获取所有的产品详情。而 API 网关内部则会通过调用各个微服务(产品信息、推荐、评论等)，并合并结果，完成响应。

同时，API 网关还能为不同的客户端提供定制的 API。比如，对于手机、电脑、平板、电视、机顶盒等不同的系统，API 网关通过运行特定于设备的适配器代码来为每个设备提供一个定制的 API，实现各个客户端都能得到最合适的数据。

总结来说：**使用 API 网关的最大优点是，它封装了应用程序的内部结构**。客户端只需要同网关交互，而不必调用特定的服务。API 网关为每一类客户端提供了特定的 API，这减少了客户端与应用程序间的交互次数，还简化了客户端代码。

### 1.4 API 网关的不足

引入 API 网关之后，也会增加一个必须开发、部署和维护的高可用组件，而且 API 网关也变成了开发的瓶颈。

为了暴露每个微服务的端点，开发人员必须更新 API 网关。API 网关的更新过程要尽可能地简单，否则，为了更新网关，开发人员将不得不排队等待。

不过，虽然有这些不足，但对于大多数现实世界的应用程序而言，使用API网关是合理的。

## 二、API 网关技术实现

### 2.1 API 网关架构

API 网关一般可以拆分成三个子系统：

* Gateway-Core 核心系统，负责接收客户端请求，调度、加载和执行组件，将请求路由到上游服务端，并处理返回的结果给客户端。大多数的功能都在这一层完成，例如：验证、鉴权、负载均衡、协议转换、服务路由、数据缓存等。
    
* Gateway-Admin 管理系统，可以进行 API、组件等系统基础信息的配置，例如：限流策略、缓存管理、告警设置。

* Gateway-Monitor 监控系统，负责监控日志、生成各种运维管理报表、自动告警等。

即便没有其他的两个子系统，核心系统也是可以单独运行的。而管理和监控系统主要是为核心系统服务的，起到支撑的作用。

### 2.2 链式处理

设计模式有一种责任链模式，将处理请求和处理步骤分开。每个处理步骤只关心这个步骤上需要做的处理操作，处理步骤存在先后顺序。消息从第一个处理步骤流入，从最后一个处理步骤流出，整个过程形成了一个链条。

API 网关中也用到了类似的设计模式。以 Zuul 为例，当消息出入网关时，需要经历一系列的过滤器。这些过滤器之间是又先后顺序的，并且在每个过滤器需要进行的工作也各不一样：

* PRE：前置过滤器，用来处理通用事务，比如鉴权、限流、熔断降级、缓存，并且可以通过 Custom 过滤器进行扩展。
* ROUTING：路由过滤器，在这种过滤中把用户请求发送给 Origin Server，主要负责进行协议转化和路由的工作。
* POST：后者过滤器，从 Origin Server 返回的响应信息会经过它，再返回给调用者。在返回的 Response 中加入 Response Header，同时可以做 Response 的统计和日志记录。
* ERROR：错误过滤器，当上面三个过滤器发生异常时，错误信息会进入到这里，在这里对错误进行处理。

![](http://cnd.qiniu.lin07ux.cn/markdown/1572926548610.png)

### 2.3 异步请求

所有的请求通过 API 网关访问服务，而 API 一般需要调用多个后端服务并合并结果来生成响应。为了最小化响应时间，API 网关应该并发执行独立请求。然而，有时候请求之间存在依赖，在将请求路由到后端服务之前，API 网关可能首先需要调用身份验证服务验证请求的合法性。类似地，为了获取客户意愿清单中的产品信息，API 网关必须首先获取包含那些信息的客户资料，然后再获取每个产品的信息。

当吞吐量上去之后，API 网关就会遇到性能瓶颈，从而会影响系统的整体可用性。这就需要 API 网关能够尽量减少处理每个请求的等待时间，提高可连接数，比如可以使用异步编程等。

下面以 Zuul 为例进行说明。

Zuul1 采用一个线程处理一个请求的方式，线程负责接受请求，然后调用相关处理逻辑，并返回结果。如果把网络请求看成一次 IO 操作的话，处理请求的线程从接受请求到返回相应，都是阻塞状态。同时，如果多个线程都处在这种状态，就会导致系统运行缓慢。而每个网关能够开启的线程数量是有限的，特别是在访问的高峰期，很容易造成请求被延迟甚至无法响应的问题。

![每个线程处理一个请求](http://cnd.qiniu.lin07ux.cn/markdown/1572929847549.png)

为了解决这个问题，Zuul2 使用了异步请求的机制。每个请求进入网关的时候，会被包装成一个请求事件。CPU 内核会维持一个监听器，不断轮询请求事件，一旦发现请求事件，就会调用对应的应用进行处理。获取到应用返回的信息以后，按照请求的要求把数据/文件放到指定的缓冲区，同时发送一个通知事件，告诉请求端数据已经就绪，可以从这个缓冲区获取数据/文件了。

这个过程是异步的，请求的线程不会一直等待数据的返回，它在生成请求事件以后就返回了，这时它可以做其他的事情。而当 CPU 内核获取到返回数据，并将其发送到指定的数据缓冲区时，请求的线程就会接到数据返回的通知，然后它就可以直接使用数据生成相关响应了。由于请求线程不需要自己去获取数据，所以能够同时处理相当多的请求。

![异步请求处理](http://cnd.qiniu.lin07ux.cn/markdown/1572930185062.png)

实现异步处理请求有两种模式，分别是：

* Reactor：通过`handle_events`事件循环处理请求。用户线程注册时间处理器之后，就可以继续执行其他的工作(异步)，而 Reactor 线程负责调用内核的 Select 函数检查 Socket 的状态。当 Socket 被激活时(获取网络数据)，则通知相应的用户线程执行`handle_event`进行数据读取、处理的工作。流程如下所示：

    ![](http://cnd.qiniu.lin07ux.cn/markdown/1572930290401.png)

* Proactor：用户线程使用 CPU 内核提供的异步 IO 发起请求，然后立即返回。CPU 内核则继续执行用户请求线程代码。此时用户线程已将 AsynchronousOperation(异步处理)和 CompletionHandler(完成获取资源)注册到内核。之后操作系统开启独立的内核线程去处理 IO 操作。当请求的数据到达时，由内核负责读取 Socket（网络请求）中的数据，并写入用户指定的缓冲区中。最后内核将数据和用户线程注册的 CompletionHandler 分发给内部 Proactor，由其将 IO 完成的信息通知给用户线程(一般通过调用用户线程注册的完成时间处理函数)，完成异步 IO。处理流程如下图所示：

    ![](http://cnd.qiniu.lin07ux.cn/markdown/1572930579317.png)

### 2.4 服务发现

API 网关需要知道它与之通信的每个微服务的位置(IP 和端口)才能实现自动调用微服务，生成响应。在传统的应用程序中，获许可与硬连线这个位置，但在现代的、基于云的微服务应用程序中，这并不是一个容易解决的问题。

基础设置服务(如消息代理)通常会有一个静态位置，可以通过 OS 环境变量指定，但是确定一个因公用程序服务的位置没有这么简单。应用程序服务的位置是动态分配的，而且单个服务的一组实例也会随着自动扩展或升级而动态变化。

总之，像系统中的其他服务客户端一样，API 网关需要使用系统的服务发现机制，可以是服务器端发现，也可以是客户端发现。需要注意的是，如果系统使用客户端发现，那么 API 网关必须能够查询服务注册中心，这是一个包含所有微服务实例及其位置的数据库。

### 2.5 处理局部失败

在实现 API 网关时，还需要处理局部失败的问题。该问题在所有的分布式系统中都会出现，无论什么时候，当一个服务调用另一个响应慢或不可用的服务时，就会出现这个问题。

API 网关永远不能因为无限期的等待上游服务而阻塞。不过，如何处理失败取决于特定的场景以及是哪个服务失败。

例如，在产品详情场景下，如果推荐服务无响应，那么 API 网关应该向客户端返回产品详情的其他内容，因为这些内容对用户依然有用。推荐内容可以为空，也可以用一个规定的 TOP 10 列表取代。不过，如果产品信息服务无响应，那么 API 网关应该向客户端返回一个错误信息。

如果缓存数据可用，那么 API 网关还可以返回缓存数据。例如，由于产品价格不经常变化，所以如果价格服务不可用，API 网关可以返回缓存的价格数据。数据可以由 API 网关自己缓存，也可以存储在像 Redis 或 Memcached 那样的外部缓存中。通过返回默认数据或者缓存数据，API 网关可以确保系统故障不影响用户的体验。

## 三、API 网关功能

### 3.1 协议转换

系统内部的每个微服务所使用的协议可能各不相同，那么系统之间的低矮用或者数据传输，就存在协议转换的问题了。

API 网关通过泛化调用的方式实现协议之间的转化。实际上就是将不同的协议转换成“通用协议”，然后再将通用协议转化成本地系统能够识别的协议。

### 3.2 负载均衡

当 API 网关后面挂接同一应用的多个副本时，每次用户的请求都会通过网关的负载均衡算法路由到对应的服务上面。

如果上游服务采用微服务的架构，也可以和注册中心合作实现动态的负载均衡：当微服务动态挂载(动态扩容)的时候，可以通过服务注册中心获取微服务的注册信息，从而实现负载均衡。

![Nginx+Lua+服务注册中心实现动态负载均衡](http://cnd.qiniu.lin07ux.cn/markdown/1572931348524.png)

### 3.3 路由选择

API 网关可以根据请求的 URL 地址解析知道要访问的服务，再通过路由表把请求路由到目标服务上去。

有时候应该网络原因，服务可能会暂时的不可用，这时候可以设置一定时间后，再次对服务进行重试。

![Zuul 作为 API 网关将请求路由到上游服务器](http://cnd.qiniu.lin07ux.cn/markdown/1572931460023.png)

### 3.4 流量控制

限流是 API 网关常用的功能之一，当上游服务超出请求承载范围，或者服务因为某种原因无法正常使用，都会导致服务处理能力下降。这时候 API 网关作为看门人，就可以限制流入的请求，让应用服务器免受冲击。

限流实际上就是限制流入请求的数量，比如可以使用令牌桶算法、漏桶算法、连接数限制等。

![令牌桶限流](http://cnd.qiniu.lin07ux.cn/markdown/1572931617337.png)

### 3.5 统一鉴权

访问应用服务器的请求一般都需要拥有一定权限，如果每访问一个服务都需要验证一次权限，会对请求的处理效率有很大的影响。可以将权限认证放到 API 网关来进行，由 API 网关统一鉴权之后再放行，这样各个微服务就不需要单独处理授权了。

目前比较常见的做法是：用户通过登录服务获取 Token，并将其放在客户端，在每次请求的时候把这个 Token 放入请求头，一起发给服务器。

API 网关要做的事情就是解析这个 Token，确认访问者的身份(认证)和他能做什么/访问什么(鉴权)。

如果要实现多个系统的 SSO(Single Sign On 单点登录)，API 网关需要和 CAS(Central Authentication Service 中心鉴权服务器)做连接，来确定请求者的身份和权限。

### 3.6 熔断降级

当应用服务出现异常，不能拿继续提供服务的时候，也就是说应用服务不可用了，作为 API 网关就需要将请求导入到其他服务上，或者对服务进行降级处理，例如，用兜底的服务数据返回客户端，或者提示服务暂时不可用。同时，通过服务注册中心，监听存证问题的服务，一旦服务恢复，随机恢复路由请求到该服务。

### 3.7 发布测试

在发布版本的时候一般会采用金丝雀发布和蓝绿发布方式。作为 API 网关可以使用路由选择和流量切换来协助上述行为。

下面以金丝雀发布为例，描述 API 网关如何做路由转换的。

假设需要将 4 个服务从 V1 更新到 V2 版本，这 4 个服务的流量请求由 1 个 API 网关管理。如下图所示：

![发布前状态](http://cnd.qiniu.lin07ux.cn/markdown/1572934147762.png)

此时，先将一台服务器与其他网关断开，部署 V2 版本的服务，然后 API 网关再将流量导入到 V2 版本的服务器上。此时状态如下图所示：

![](http://cnd.qiniu.lin07ux.cn/markdown/1572934205845.png)

一旦 V2 版本的服务趋于稳定，就可以继续逐步将其他服务替换成 V2 版本，实现全部的版本更新。更新后的状态如下图所示：

![](http://cnd.qiniu.lin07ux.cn/markdown/1572934270149.png)

金丝雀发布一般先发布 1 台或小比例(如 2%)的服务，主要做流量验证用，也称为金丝雀(Canary)测试(灰度测试)。金丝雀测试需要完善的监控设施配合，通过监控指标反馈，观察金丝雀的监控状况，作为后续发布或回滚的依据。如果金丝雀测试通过，则把剩余的服务进行更新，否则就回退金丝雀，发布失败。

> 金丝雀测试的来源是，旷工下矿洞前，先放一只金丝雀探查是否有毒气。

### 3.8 缓存数据

可以在 API 网关处缓存一些修改频率不高的数据，例如：用户信息、配置信息等。通过服务定期刷新这些缓存就可以了。

在 API 网关缓存数据可以方便做全局数据的缓存，减少对上游服务的访问，减少响应时间。

### 3.9 日志记录

通过 API 网关上的过滤器可以加入日志服务功能，记录请求和返回的信息。同时还可以由此建立一个管理员的界面去监控这些数据。

日志记录之后，可以做很多功能的扩展，比如：

* 报表分析：针对服务访问情况，提供可视化展示。
* 实时查询：了解实时关键信息，例如：吞吐量、并发数等。
* 异常告警：针对关键参数进行监控，对于统计结果支持阈值报警，对接阿里云通知中心、短信、钉钉进行告警。
* 日志投递：将日志进行归档，存放到文件库或数据仓库中，以便后续分析。

## 四、总结

API 网关是系统内外通讯的中介者。从定位上来说它服务 WebApp、MobileApp、合作伙伴 OpenAPI、企业内部可扩展 API、以及 IOT 设备。

从架构设计角度来说，分为 Gateway-Core（核心）、Gateway-Admin（管理）、Gateway-Monitor（监控）三部分。

API 网关需要注意的技术原理有，协议转换，链式处理以及异步请求。它的应用比较广泛，例如：负载均衡，路由选择，流量控制，统一鉴权，熔断降级，发布测试，缓存数据，日志记录等。

比较流行的开源 API网关有 Kong，Traefik，Ambassador，Zuul。从使用上来说他们各有千秋，可以根据项目的情况选取。



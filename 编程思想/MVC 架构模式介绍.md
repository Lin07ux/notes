转摘：[Yii 模式 MVC](http://www.digpage.com/mvc.html)

## MVC 简介

MVC 是一种设计模式（Design pattern），也就是一种解决问题的方法和思路， 是上世纪 80 年代提出的，到现在已经颇有历史了。 MVC 的意义在于指导开发者将数据与表现解耦，提高代码，特别是模型部分代码的复用性。

话说远了，我们还说正题。MVC是三个单词的缩写：Model, View, Controller。 MVC是一种设计模式，目前几乎所有的Web开发框架都建立在MVC模式之上。 当然，最近几年也出现了一些诸如MVP, MVVM之类的新的设计模式。 但从技术的成熟程度和使用的广泛程度来讲，MVC仍是主流。

Yii 是一个 Web 框架，从 Web 开发的分工来讲，Yii 的开发工作中，承担后端的内容多一些，毕竟主要就是 PHP 开发。 前端主要是在 HTML、JavaScript、CSS 上进行开发，然后通过 Yii 把前端的内容管起来，如通过 Assets 等。 这一章要讲的 MVC，主要是针对后端的。前端的 MVC 严格来讲不属于 Yii 的范畴，这里我们就不作过多介绍。 如果想了解前端的 MVC，可以看看 Backbone.js Angular.js 等前端框架。

## MVC 的三要素

MVC 是模型(Model)、视图(View)、控制器(Controller) 3 个单词的缩写。下面我们从这 3 个方面来讲解 MVC 中的三个要素。

`Model`是指数据模型，是对客观事物的抽象。如一篇博客文章，我们可能会以一个 Post 类来表示，那么，这个 Post 类就是数据对象。 同时，博客文章还有一些业务逻辑，如发布、回收、评论等，这一般表现为类的方法，这也是 model 的内容和范畴。 对于 Model，主要是数据、业务逻辑和业务规则。相对而言，这是 MVC 中比较稳定的部分，一般成品后不会改变。 开发初期的最重要任务，主要也是实现 Model 的部分。这一部分写得好，后面就可以改得少，开发起来就快。

`View`是指视图，也就是呈现给用户的一个界面，是 model 的具体表现形式，也是收集用户输入的地方。 如你在某个博客上看到的某一篇文章，就是某个 Post 类的表现形式。View 的目的在于提供与用户交互的界面。换句话说，对于用户而言，只有 View 是可见的、可操作的。 事实上也是如此，你不会让用户看到 Model，更不会让他直接操作 Model。 你只会让用户看到你想让他看的内容。 这就是 View 要做的事，他往往是 MVC 中变化频繁的部分，也是客户经常要求改来改去的地方。今天你可能会以一种形式来展示你的博文，明天可能就变成别的表现形式了。

`Contorller`指的是控制器，主要负责与 model 和 view 打交道。 换句话说，model 和 view 之间一般不直接打交道，他们老死不相往来。view 中不会对 model 作任何操作，model 不会输出任何用于表现的东西，如 HTML 代码等。这俩甩手不干了，那总得有人来干吧，只能 Controller 上了。Contorller 用于决定使用哪些 Model，对 Model 执行什么操作，为视图准备哪些数据，是 MVC 中沟通的桥梁。

对于 MVC 中三者的划分并没有十分明晰的定义和界线。MVC 设计模式只是一种指导思想，让你按照 model, view, controller 三个方面来描述你的应用，并通过三者的交互，使应用功能得以正常运转。

其中，View 的部分比较明确，就是负责显示嘛。一切与显示界面无关的东西，都不应该出现在 View 里面。 因此，View 中一般不会出现复杂的判断语句，不会出现复杂的运算过程。 对于 PHP 的 Web 应用而言，毫无疑问，HTML 是 View 中的主要内容。

1. 这是关于 View 的几个原则：

    - 负责显示界面，以HTML为主；
    - 一般没有复杂的判断语句或运算过程，可以有简单的循环语句、格式化语句。比如，一般博客首页的文章列表，就是一种循环结构；
    - 从不调用 Model 的写方法。也就是说，View 只 从Model 获取数据，而不直接改写 Model，所以我们说他们老死不相往来。
    - 一般没有任何准备数据的代码，如查询数据库、组合成一定格式的字符串等。 这些一般放在 Controller 里面，并以变量的形式传给视图。 也就是说，视图里面要用到的数据，都是拿来就能直接用的变量。
    - 对于 Model 而言，最主要就是保存事物的信息，表征事物的行为和对他可以进行的操作。 比如， Post 类必然有一个用于保存博客文章标题的 title 属性，必然有一个删除的操作，这都是 Model的内容。

2. 以下是关于 Model 的几个原则：

    - 数据、行为、方法是 Model 的主要内容；
    - 实际工作中，Model 是 MVC 中代码量最大，逻辑最复杂的地方，因为关于应用的大量的业务逻辑也要在这里面表示。
    - Model 所提供的数据都是原始数据。也就是说，不带有任何表现层的代码。比如，一般不会在输出的数据中添加 HTML 标签，这是 View 的工作。但是 Model 可以提供有结构的数据，数组结构、队列结构、乃至其他 Model 等。 这个结构并非是表现层的格式，而是数据在内存中的表现。
    - 与输出不同，Model 的输入数据，可以是带有表现格式的数据。 如将一篇文章保存到 Post 里面，内容中必然包含各种 HTML 标签。 因此，Model 一般要对输入数据作过滤、验证和规范化等预处理。特别是对于需要保存进数据库的，一定要对所有的输入数据作预处理。这些预处理，有的其实是业务逻辑。比如只有主编才可以删除文章，这一验证规则既也是业务逻辑，也是权限控制。而有些预处理，则不属于业务逻辑，比如，文章标题前后的空格应去除。

    注意与 Controller 区分开：Model 是处理业务方面的逻辑，Controller 只是简单的协调 Model 和 View 之间的关系，只要是与业务有关的，就该放在 Model 里面。好的设计，应当是胖 Model，瘦 Controller。

    对于 Controller，主要是响应用户请求，决定使用什么视图，需要准备什么数据用来显示。

3. 以下是有关 Controller 的设计原则：

    - 用于处理用户请求。因此，对于 reqeust 的访问代码应该放在 Controller 里面，比如`$_GET` `$_POST`等。但仅限于获取用户请求数据，不应该对数据有任何操作或预处理，这些工作应该交由 Models 来完成。
    - 调用 Models 的读方法，获取数据，直接传递给视图，供显示。当涉及到多个 Model 时，有关的逻辑应当交给 Model 来完成。
    - 调用 Model 的写方法，对 Models 进行写操作。
    - 调用视图渲染函数等，形成对用户 Reqeust 的 Response。


## Model 设计参考

在 MVC 中，Model 排第一，是有一定暗示的：一是 Model 是整个架构中，代码量最大，复用程度最高， 也是最体现程序员设计功力的地方；二是 View 和 Controller 相对于 Model 而言，在实际开发中，复用程度不高，逻辑复杂程度较低。可以说，Model 设计得好，整个 MVC 就好，应用开发起就顺。

因此，这一节将以 Model 为核心，来讲 MVC 的设计。实话说，MVC 尽管提出了 Model View Controller 的划分思想，但到了具体实操中，并不是很好把握的。下面介绍的设计参考，也仅仅是个人在实际项目中的一些体会和想法，仅作参考。在具体设计中，可以把握这么几点：

### Model 应当集中整个应用的数据和业务逻辑

应用当中涉及到的所有业务对象都应尽可能抽像成 Model。如，博客系统当中，文章要抽象成 Post，评论要抽象成 Comment。而相关的业务逻辑，如发布新文章可以用`Post::create()`，删除评论可以用`Comment::delete()`。 这样子整个应用就显得很清晰明了。

### 基础 Model 应当尽可能细化

在一个应用中，特别是对于大型复杂应用，Model 间关系可能比较复杂。在构造应用时，特别是基础 Model 时， 要从足够小的粒度来设计。 此时，就要考虑采取继承、封装等措施了。比如，一个博客文章 Post，一般包含了若干标签，在页上一般写在作者、日期等 Post 字段的旁边。 从逻辑上来看，把标签作为 Post 的一个属性，是说得通的。 但是如果把标签作为一个属性像标题、正文等字段一样依附于 Post。那么在有的功能上，实现起来是有难度的。比如，客户要求，当一个 Post 含有标签 “yii, model” 时，可以点击 “yii” ， 然后系统列出所有具标签中含有 “yii” 的文章。

为了实现这个功能，正确的设计是单独将标签抽象成 Tag。这样，Post 和 Tag 是多对多的关系，即一个 Post 有多个 Tag，一个 Tag 也对应多个 Post。这个多对多关系可以通过一张数据表`tbl_post_tag`来表示。接下来，为 Post 增加`Post::getTags()`方法，并通过 `tbl_post_tag`表来查询当前 Post 的所有标签。同时，为 Tag 增加`Tag::getPosts()`方法，也通过`tbl_post_tag`表来查询当前 Tag 对应的文章。这样，就具备了实现客户要求的新功能的基础。

因此，在 Model 设计上，要以尽量小的粒度进行设计。一般而言，粒度越小，复用的可能性就越高。

有的读者可能会问了，既然要求粒度尽可能地小，那么，Post 是不是也应当再细化，把段落抽象为 Model？ 是否有这个必要，看客户需求。一般情况确实没有这必要，如果这么做，那是不是再以句子为单位进行抽象？ 但如果客户要求这个博客系统的评论是针对段落进行的评论的， 要将评论显示在对应的段落旁边，甚至显示每个段落评论人次等功能。那么就需要把段落抽象成 Model 了。

### 分层次设计 Model

从设计流程上，数据库结构设计与 Model 的设计是紧密相关的。先有数据库结构设计，后有 Model 设计。在设计数据库结构的时候，也是在设计 Model。一般而言，最单元、粒度最小的 Model 就是根据每个数据库表所生成的 Model，这往往是个 Active Record。

比如标签的问题，在数据库存储过程中，Post 和 Tag 是分开存的，而且这两个表的字段，没有冗余。`tbl_post_tag`表也只记录他们的 ID，没有实质内容。

在获取数据渲染视图，向用户展现时，这两个 Model 及他们的字段，是完全够用，且没有冗余的。

那么，能不能说 Post 和 Tag 这两个 Model 是够用的呢？显然还不够。

当用户在创建文章、修改文章、审核文章时，需要采用一个表单来显示来收集用户输入。 其中，对于标签的采集，一般是一个长条的文本框，让用户一次性输入多个标签，并以`,`等进行分隔的。

但是，这个文本框没有一个字段与之进行对应。我们也没办法对这个字段的用户输入进行任何的验证、预处理。

因此，Post 的功能是不够用的。不够用怎么办？那就加吧。但直接在 Post 里面加个`public $tagString`并不好。 毕竟只是在使用表单时，才会有这个问题，其他场合，这个字段是没用的。

这种情况下，一般使用继承:

```php
public class PostForm extends Post
{
    public $tagString;

    ... ...
}
```

这样，当控制器发现用户在创建、修改、审核文章时，可以使用 PostForm Model 来渲染视图了， 而其他场合则仍使用 Post。这样就在需要时，增加了一个`tagString`的字段用于收集用户输入的标签。

在具体设计过程中，由于 Model 本身就会包含很多代码，因此，要多使用这继承等手段，把代码组织好。

### 仔细为 Model 方法命名

由于 Model 的代码量比较大，又集中了大量的逻辑，因此，会在一个 Model中有大量的方法。仍然以 Post 为例， 会涉及到创建、审核、发布、回收等流程，相关的方法比较多，在命名上要用心。 可能会涉及到的、名字又比较接近的方法就有：

- `getPrevPost()`，前一篇文章，用于导航
- `getNextPost()`，下一篇文章，用于导航
- `getRelatedPosts($n = 10)`，获取相关的N篇文章，用于相关文章推荐列表
- `getPostsOfAuthor($n = 10)`，获取同一作者的N篇相关文章，用于作者文章列表
- `getLatestPosts($n = 10)`，最新的N篇文章，静态方法，用于文章列表或RSS输出
- `getHotestPosts($n = 10)`，最热门的N篇文章，静态方法，用于热门文章列表
- `getPublishPosts($n = -1)`，获取已经发布的N篇文章，静态方法，用于文章列表
- `getDraftPosts($n = -1)`，获取未发布的N篇文章，静态方法，用于作者页面

这里只是一些获取其他 Post 的方法，命名比较合理，一看就知道意思。而且全部写成`getter`的形式，可以使用读取属性的方式进行访问。

不单单是在 Model 方法的命名上要用心，在变量名、类名、方法名等的命名上，也要养成习惯，形成规律。不要图一时之快，胡乱起名。否则，出来混，迟早要还的。

## MVC 与前后端的配合

从 MVC 的起源来讲，是从桌面应用的开发中发展起来的。从本质来讲，这是一种解决问题的思路和办法。从实践来讲，这是一种久经考验的有效方式。但是如开头我们讲的，Yii 更多的是侧重于后端。 对于 Web 应用而言，包含 Yii 在内的许多 Web 开发框架，都是没有办法知道用户的操作，如鼠标、键盘等操作的。Web 应用想要了解用户的操作，只能依靠用户发送 Request。而对于鼠标、键盘等的响应，只能依靠前端技术，如 JavaScript 等来实现。

再加上这几年来 Web 浏览器的功能日臻强大。因此，Web 应用开发出现了一个新的发展苗头，就是功能从后端往前端转移。

在前端，通过 JavaScript 捕获用户操作，进行相应处理。或是发送回后端获取响应后处理，如通过 ajax 请求后端数据，实现无刷新的局部页面更新，向用户进行反馈；或直接在前端由浏览器进行处理，如使用 backbone.js、Angular.js 等前端框架的数据绑定功能等。这些都使得 Web 应用表现得越来越像桌面应用。

后端 MVC 也在为前后端的发展而改变。Controller 的功能更多的变成了识别是 ajax 请求还是普通请求，并根据请求的不同采取相应的视图渲染方式。对于普通请求，正常渲染视图，输出 HTML。对于 ajax 请求，则返回局部渲染视图，输出 HTML 片段。有的甚至输出 XML 或者 JSON。唯一在大潮流中，巍然不动的，还是我们的大 Model。





> 转摘：[PageRank 算法初步了解](https://www.cnblogs.com/dacc123/p/12500411.html)

### 1. 马尔科夫链

说到 PageRank 就要提到马尔科夫链，因为 PageRank 算法在计算的过程中，和马尔科夫链转移是十分相似的，只是 PageRank 算法在马尔科夫链的转移上做了一些改动。

马尔科夫链的[维基百科](https://zh.wikipedia.org/zh-cn/%E9%A9%AC%E5%B0%94%E5%8F%AF%E5%A4%AB%E9%93%BE)里是这样说的：

> 马尔科夫链是满足马尔科夫性质的随机变量序列 𝑋<sub>1</sub>,𝑋<sub>2</sub>,𝑋<sub>3</sub>...。即：给出当前状态，将来状态和过去状态是相互独立的。从形式上看，如果两边的条件分布有定义 Pr(𝑋<sub>1</sub> = 𝑥<sub>1</sub>,...,𝑋<sub>n</sub> = 𝑥<sub>n</sub>) > 0，则 Pr(𝑋<sub>n+1</sub> = 𝑥 | 𝑋<sub>1</sub> = 𝑥<sub>1</sub>,𝑋<sub>2</sub> = 𝑥<sub>2</sub>,...,𝑋<sub>n</sub> = 𝑥<sub>n</sub>) = Pr(𝑋<sub>n+1</sub> = 𝑥 | 𝑋<sub>n</sub> = 𝑥<sub>n</sub>)。
> 𝑋<sub>i</sub> 的可能值构成的可数集 S 叫做该链的“状态空间”。

形式定义好像有点复杂，这里只介绍我自己所认识的马氏链，一个简单通俗易懂的马氏链。

假设有一个离散型随机变量 w，表示的是当前社会中的贫穷、中等和富有的人的概率。其初始分布是：`w = (0.21, 0.68, 0.11)`，表示社会中贫穷的人占 28%，中等的人占 68%，富有的人占 11%。可以想象成这是我们所处地球的第一代人 𝑋<sub>1</sub> (那个时候就有贫富差距了)。

接下来第一代人要生小孩，形成第二代人 𝑋<sub>2</sub>，第二代人最终也会有部分是穷人，部分是中等，部分是富人。这个就叫做状态转移，从 𝑋<sub>1</sub> 转移到 𝑋<sub>2</sub>。但是这个转移并不是说直接平移，也就是穷人的还是都是穷人，中等人的孩子还是中等人，富人的孩子还是富人。而是各个阶层的下一代都有一定的概率实现阶层跨越，从穷人变成中等，甚至变成富人。

这个阶层跨越的概率假如是如下表：

|          | 儿子是穷人 | 儿子是中等 | 儿子是富人 |
|----------|----------|-----------|----------|
| 父亲是穷人 | 0.65     | 0.28      | 0.07     |
| 父亲是中等 | 0.15     | 0.67      | 0.18     |
| 父亲是富人 | 0.12     | 0.36      | 0.52     |

上述表格代表的是，父亲属于哪个阶级时，那儿子属于某个阶级的概率。比如父亲是富人，儿子也是富人的概率是 0.52，这表示大概一半的富二代以后都会败光家产。所以根据以上表格，第二代 𝑋<sub>2</sub> 中穷人的概率是`0.21 ∗ 0.65 + 0.68 ∗ 0.15 + 0.11 ∗ 0.12 = 0.252`。

以上的计算过程实际上就是矩阵相乘，表格里的数据组成一个矩阵 𝑃 叫做概率转移矩阵。于是就有第二代人各个阶层的人概率(占比)：

<div style="text-align:center">
    <img src="http://cnd.qiniu.lin07ux.cn/markdown/1590225602343.png" width="307"/>
</div>

以此类推，不断计算，不断进行状态转移，我们发现从第 7 代开始，各个阶层的占比就稳定不变了：

<div style="text-align:center">
    <img src="http://cnd.qiniu.lin07ux.cn/markdown/1590225714736.png" width="259"/>
</div>

这个结果并不是偶然的。实际上吗，从任意一个 𝑋<sub>1</sub> 的分布出发，经过概率转移矩阵，最终都会收敛到一个稳定的分布 `𝜋 = {0.286,0.489,0.225}`。从 𝑋<sub>1</sub> → 𝑋<sub>2</sub> → 𝑋<sub>3</sub> ... → 𝑋<sub>n</sub> 这个状态转移的链条就是马尔科夫链。它最终会收敛到稳定的分布 𝜋，也就是`𝜋 ⋅ 𝑃 = 𝜋`。

至于为什么会这样，肯定是和状态转移矩阵有关，最终的稳定分布不是由初始状态 𝑋<sub>1</sub> 决定的，而是由转移矩阵 𝑃 决定的，具体就不细究了。
 
总之，可以得出这样一个结论：如果有一个随机变量分布为 𝑋 和状态转移矩阵 𝑃，随机变量分布的下一个状态 𝑋<sub>next</sub> 可以由上一个状态 𝑋<sub>pre</sub> 乘以矩阵 𝑃 得到。那么经过 n 步迭代，最终会得到一个不便的、平稳的分布。

### 2. PageRank

PageRank 是 Google 搜索引擎的网页排名算法，它是把所有网页都构成一张图，每个网页都是一个节点，如果一个网页中有链向其他网页的链接，那么就有一条有向边连接这两个点(网页)。

有了这张图之后，PageRank 认为，每条边都是一个投票动作，`𝐴 → 𝐵`就表示 A 在给 B 投票，B 的权重就会增加。

举个例子：假设互联网上一共就 4 个页面：A、B、C、D，其中 B 页面有两个超链接指向 A、C，C 中有 1 个超链接指向 A，D 中有三个超链接指向 A、B、C。根据这个描述画成一张有向图，如下所示：

<div style="text-align:center">
    <img src="http://cnd.qiniu.lin07ux.cn/markdown/1590226600335.png" width="326"/>
</div>

这里首先要清楚 PageRank 计算的值是什么。PageRank 计算的最终值是每个网页被网民点击浏览的概率，也就相当于权重。所以这还是一个离散型随机变量：𝑊 = { 𝑝<sub>𝑎</sub>, 𝑝<sub>𝑏</sub>, 𝑝<sub>𝑐</sub>, 𝑝<sub>𝑑</sub> }。

PageRank 的计算过程就和上面所说的马尔科夫链一样，初始状态 𝑊<sub>0</sub> 就是全球网民同时上网，每个网民每次只点击一次网页，每个网页被访问的概率。由于马尔科夫链的最终稳定状态与初始状态无关，所以我们可以假设一开始每个网页被浏览的概率是相同的，每个页面被网民点击的概率都是 0.25，也就是说：𝑊<sub>0</sub> = { 0.25, 0.25, 0.25, 0.25 }。

那么对于状态 2 的概率分布 𝑊<sub>1</sub> 就是全体网民开始点击浏览第二个网页时，每个网页被访问的概率。

PageRank 也有一个概率转移矩阵 𝑃，而 𝑃 就存在于上图中，其中 𝑃<sub>𝑖,𝑗</sub>表示网页 i 链向网页 j 的连接数处于网页 i 的所有外链数。其意思就是，当你访问网页 i 的时候，有多大概率访问网页 j。所以对于某个特定的状态 𝑊<sub>𝑛</sub>（全体网民第 n 次点击时访问每个页面的概率），是由上一个状态 𝑊<sub>𝑛-1</sub>（全体网民第 n - 1 次点击时访问每个页面的概率），通过某个概率转移而来。这和上面的穷人、中等、富人的示例非常相似。

计算 A 页面在第 n 次被访问的概率就可以使用下面的式子表示：

<div style="text-align:center">
    <img src="http://cnd.qiniu.lin07ux.cn/markdown/1590227407992.png" width="310"/>
</div>

而对于第二次点击的各个页面被访问的概率，可以用下面的式子表示：

<div style="text-align:center">
    <img src="http://cnd.qiniu.lin07ux.cn/markdown/1590227447232.png" width="417"/>
</div>

整个 PageRank 进行不断的迭代计算，最终会得到一个平稳分布状态 𝜋，这就是最终每个网页被网民点击的概率，或者叫做权重、排名。

下面来具体计算一下，上述四个页面 A、B、C、D 的最终权重是多少。利用下面的一段 C++ 程序来模拟 PageRank 的计算过程：

```C++
int main()
{
    int n=4;
    double d=0.85;
    double a[4]={0.25,0.25,0.25,0.25};

    double b[4][4]={{0,0,0,0},{1,0,1,0},{1,0,0,0},{1,1,1,0}};
    double linkNums[4]={0,2,1,3};

    printf("转移矩阵:\n");
    double p[4][4];
    for(int i=0;i<4;i++)
    {
        for(int j=0;j<4;j++)
        {
            p[i][j] = b[i][j]==0?0:b[i][j]/linkNums[i];
            printf("%.3f ",p[i][j]);
        }
        printf("\n");
    }
    printf("\n");
    
    printf("初始状态:\n");
    for(int i=0;i<4;i++)
    {
        printf("%.3f ",a[i]);
    }
    printf("\n");
    
    double c[4];
    int i=0;
    int pos=0;
    
    while(1)
    {

        for(int i=0;i<4;i++) {

            double x=0;

            for (int j = 0; j < 4; j++) {

                x+=a[j]*b[j][i];
            }
            c[i]=x;
            //c[i]=1.0*(1-d)/n + d*x;
        }

        int tag=0;
        for(int i=0;i<4;i++) {

            if(a[i] != c[i])
            {
                tag=1;
                a[i]=c[i];
            }
        }

        pos++;
        printf("状态%d :\n",pos);

        for(int i=0;i<4;i++)
        {
            printf("%.3f ",a[i]);
        }
        printf("\n");
        printf("\n");

        if (tag==0)
            break;
    }
}
```

其中 p 是转移矩阵，a 是我们要求的随机变量的分布。运行结果如下：

```
转移矩阵:
0.000 0.000 0.000 0.000 
0.500 0.000 0.500 0.000 
1.000 0.000 0.000 0.000 
0.333 0.333 0.333 0.000 

初始状态:
0.250 0.250 0.250 0.250 
状态1 :
0.750 0.250 0.500 0.000 

状态2 :
0.750 0.000 0.250 0.000 

状态3 :
0.250 0.000 0.000 0.000 

状态4 :
0.000 0.000 0.000 0.000 

状态5 :
0.000 0.000 0.000 0.000 
```

最终平稳分布的状态居然是`{0, 0, 0, 0}`！为什么会发生这样的情况呢？因为没有任何网页链接到 D 这个网页，所以在转移的过程中，它的下个状态肯定是 0，又因为 D 的概率变成 0 了，会影响到所有它所链接到的网页，最终会导致素有的网页的概率值都变成 0。

为了避免这样的情况，PageRank 引入了一个阻尼系数 d 和随机访问的概念。d 是一个值在 0 - 1 之间的概率。这个 d 的物理意义是：当你浏览一个网页的时候，继续点击网页中的链接浏览下一个网页的概率。那么`1 - d`表示的就是浏览到一个网页的时候，不通过该网页中的链接继续访问下一个网页，而是新开一个窗口随机访问其他网页的概率。所以，PageRank 认为，访问网页的时候，要么是通过网页中的链接点击，要么是随机访问。

有了这个阻尼系数 d，原先途中的情况就发生了变化了，每个网页都有很多条隐形的边，指向所有其他的网页，这些隐形的边表示的是不通过链接点击而是随机访问。因此在计算 A 页面在第 n 次访问时的概率时，其计算公式就要发生变化了：

<div style="text-align:center">
    <img src="http://cnd.qiniu.lin07ux.cn/markdown/1590229130168.png" width="421"/>
</div>

其物理意义也很好理解：原先从别的网页通过链接点击过来是有一定的概率的，概率就是 d。而从任意一个网页随机访问而来的概率是 1 / N，还要乘以`1 - d`。

因此，网民第 n 次点击时访问各个网页的概率计算公式就变成如下了：

<div style="text-align:center">
    <img src="http://cnd.qiniu.lin07ux.cn/markdown/1590229317154.png" width="234"/>
</div>

修改一下程序之后，重新运行，结果如下：

```
转移矩阵:
0.000 0.000 0.000 0.000 
0.500 0.000 0.500 0.000 
1.000 0.000 0.000 0.000 
0.333 0.333 0.333 0.000 

初始状态:
0.250 0.250 0.250 0.250 
状态1 :
0.675 0.250 0.463 0.038 

状态2 :
0.675 0.069 0.282 0.038 

状态3 :
0.368 0.069 0.128 0.038 

状态4 :
0.237 0.069 0.128 0.038 

状态5 :
0.237 0.069 0.128 0.038
```

最终四个网页的权重在第五步的时候就收敛了，可以看到，A 网页的权重是最该的，因为它被指向的链接是最多的。

以上就是对 PageRank 算法的初步了解了，可以看到，它也算是马尔科夫链的应用之一。



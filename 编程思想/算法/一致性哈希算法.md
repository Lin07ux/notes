> 转摘：[图解一致性哈希算法，全网（小区局域网）最通俗易懂](https://mp.weixin.qq.com/s/jAiqJtC3SlwJN8yAJ6TRtw)

### 1. 哈希

哈希表也称为散列表，是根据键直接访问在指定存储位数数据的数据结构。通过计算一个关于键的函数也称为哈希函数，将所需查询的数据映射到表中一个位置来访问记录，加快查找速度。这个映射函数称作“散列函数”，存放记录的数组称作散列表。

散列函数能使对一个数据序列的访问过程更加迅速有效，是一种空间换时间的算法，通过散列函数，数据元素将被更快定位。常见的哈希算法有 MD5、RCR、MurmurHash 等算法。

在分布式集群缓存的负载实现中（比如 Redis 缓存集群），需要把缓存数据的 Key 利用哈希函数散列，这样缓存数据能够均匀分布到各个分布式存储节点上。要实现这样的负载均衡一般可以用哈希算法来实现。

### 2. 普通哈希算法负载均衡

要实现负载均衡，一般就可以使用哈希函数将缓存数据均匀的映射到服务器集群上。下面使用简单的“取模法”来说明这个过程。

假设有 3 个服务器节点编码 0~2，6 个缓存键值对应编号 1~6，则完成哈希映射之后，三个缓存数据映射情况如下：

```
哈希计算公式：key % 节点总数 = Hash节点下标
1 % 3 = 1
2 % 3 = 2
3 % 3 = 0
4 % 3 = 1
5 % 3 = 2
6 % 3 = 0
```

![缓存哈希实例](http://cnd.qiniu.lin07ux.cn/markdown/1610289808700.png)

每个连接都均匀的分散到了三个不同的服务器节点上，看起来很完美。但是，在分布式集群系统的负载均衡实现上，这种模型有两个问题：

* 扩展能力差：在动态扩容的时候，每个缓存键对应的哈希值虽然不变，但是可能会映射到不同的服务器上去，导致原有的哈希映射大面积失效，这就需要对缓存的数据进行迁移。比如，增减了一个服务器之后，原本的 6 个缓存键在重新映射之后，就变成了下图的样子，这其中就需要对其中的 4 个缓存进行迁移：

    ![缓存哈希扩展性示意图](http://cnd.qiniu.lin07ux.cn/markdown/1610290245303.png)

* 容错能力不佳：同样的，如果某个服务器节点宕机了，也需要进行重新映射，此时也涉及到缓存数据的迁移。比如，节点 2 宕机之后，就需要将多个缓存个重新迁移到节点 1 和节点 2 了：

    ![缓存哈希容错性示意图](http://cnd.qiniu.lin07ux.cn/markdown/1610290459921.png)

### 3. 一致性哈希算法复制均衡

一句话概括一致性哈希：是普通取模哈希算法的改良版，哈希函数计算方法不变，只不过是通过构建环状的 Hash 空间代替普通的线性 Hash 空间。

具体做法如下：

* 首先：选择一个足够大的 Hash 空间（一般是 0~2^32）构成一个哈希环：

    ![一致性哈希环]("http://cnd.qiniu.lin07ux.cn/markdown/1610290761671.png")

* 然后：对于缓存集群内的每个存储服务器节点计算 Hash 值，可以用服务器的 IP 或主机名计算得到哈希值，计算得到的哈希值就是服务器节点在 Hash 环上的位置：

    ![节点哈希](http://cnd.qiniu.lin07ux.cn/markdown/1610290843856.png)

* 最后，对每个需要存储的数据 Key 同样也计算一次哈希值，计算之后的哈希也映射到环上，**数据存储的位置是沿顺时针的方向找到的环上的第一个节点**。下图举例展示了节点存储的数据情况：

    ![数据存储哈希环](http://cnd.qiniu.lin07ux.cn/markdown/1610290995593.png)

### 4. 一致性哈希的优点

一致性哈希有如下的优点，能够解决普通哈希算法的问题：

* 扩展能力提升：当服务器集群需要进行扩容的时候，受到影响的只有环上在新增的节点之后的节点上存储的部分数据，其余节点存储的节点保持不变。

    ![一致性哈希-扩展节点](http://cnd.qiniu.lin07ux.cn/markdown/1610291251320.png)

* 容错能力提升：**在一致性哈希环上，能把节点宕机造成的影响控制在顺时针相邻节点之间，避免对整个集群造成影响**。如下图所示，假设 node2 节点宕机下线，则原来存储于 node2 的数据 value2 和 value5 ，只需按顺时针方向选择新的存储节点 node0 存放即可，不会对其他节点数据产生影响：

    ![一致性哈希-删除节点](http://cnd.qiniu.lin07ux.cn/markdown/1610291435675.png)

### 5. 一致性哈希缺点

在理想情况下，一致性哈希可以运行良好，但是在实际使用中还有一些实际问题需要考虑。

* **数据倾斜**：如果集群内服务节点节点比较少，而哈希环的空间又很大，这就可能会导致较少的服务节点哈希值聚集在一起。这就会导致缓存的数据大量的映射到同一个节点上，使得这个节点的压力很大，这种情况称为数据倾斜。

    ![](http://cnd.qiniu.lin07ux.cn/markdown/1610291989155.png)

* **节点雪崩**：数据倾斜和节点宕机都可能会导致缓存雪崩。比如，如果某个节点宕机了，那么这个节点的数据都会打到后面的节点上，造成后面的一个节点压力增大，也发生宕机。继而，后面的节点会被一个个的被压垮。总之，连锁反应导致的整个缓存集群不可用，就称为节点雪崩。

    ![一致性哈希-节点雪崩](http://cnd.qiniu.lin07ux.cn/markdown/1610292437404.png)

### 6. 一致性哈希优化

可以通过“虚拟节点”的方式来解决上述问题。

所谓**虚拟节点**，就是对原来单一的物理节点在哈希环上虚拟出几个它的分身节点，这些分身节点就被称为“虚拟节点”。打到分身节点上的数据实际上也是映射到分身对应的物理节点上，这样一个物理节点可以通过虚拟节点的方式均匀分散在哈希环的各个部分，解决了数据倾斜问题。

由于虚拟节点分散在哈希环各个部分，当某个节点宕机下线，他所存储的数据会被均匀分配给其他各个节点，避免对单一节点突发压力导致的节点雪崩问题。

下图展示了虚拟节点的哈希环分布，其中左边是没做虚拟节点情况下的节点分布，右边背景色绿色两个的 node0 节点是 node0 节点的虚拟节点；背景色红色的 node1 节点是 node1 的虚拟节点。

![一致性哈希-虚拟节点](http://cnd.qiniu.lin07ux.cn/markdown/1610292745180.png)



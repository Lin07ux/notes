### 1. 什么是 TCP 协议

TCP 是**面向连接的**、**可靠的**、**基于字节流的**传输层通信协议：

* 面向连接：一定是「一对一」才能连接，不能像 UDP 协议那样可以一个主机同时向多个主机发送消息，也就是无法一对多；
* 可靠：无论网络链路层中出现了怎样的变化，TCP 都可以保证一个报文一定能到达接收端；
* 字节流：用户消息通过 TCP 协议传输时，消息可能会被操作系统「分组」成多个 TCP 报文，如果接收方不知道「消息的边界」，是无法独处一个有效的用户消息的。并且 TCP 报文是「有序的」，当「前一个」TCP 报文没有收到的时候，即使它先收到了后面的 TCP 报文，也是不能将其提供给应用层处理的。同时，对「重复」的 TCP 报文会被自动丢弃。

### 2. 为什么需要 TCP 协议

网络层 IP 层是「不可靠」的，不保证网络包的交付、不保证网络包的按序交付、也不保证网络包中的数据的完整性。如果需要保障网络数据包的可靠性、有序性和完整性，就需要由其上层「传输层」的 TCP 协议来负责。

TCP 是一个工作在**传输层**的**可靠**的数据传输协议，它能保证接收端接收到的网络包是**无损坏**、**无间隔**、**非冗余**和**按序**的。

### 3. 什么是 TCP 连接

RFC 793 中对「连接」的定义如下：

> Connections: The reliability and flow control mechanisms described above require that TCPs initialize and maintain certain status information for each data stream. The combination of this information, including sockets, sequence numbers, and window sizes, is called a connection.

简单来说，TCP 连接就是：**用于保证可靠性和流量控制而维护的某些状态信息，这些信息的组合，包括 Socket、序列号和窗口大小，被称为 TCP 连接**。

所以，建立一个 TCP 连接是需要客户端与服务端达成上述三个信息的共识：

* **Socket**：由 IP 地址和端口号组成
* **序列号**：用来解决乱序问题等；
* **窗口大小**：用来做流量控制。

### 4. 如何唯一确定一个 TCP 连接

TCP 四元组可以用来唯一确定一个连接，四元组包含如下信息：

* 源地址
* 源端口
* 目标地址
* 目标端口

源地址和目的地址的字段（32 位）是在 IP 头部中设置，作用是通过 IP 协议发送报文给对方主机；源端口和目的端口的字段（16 位）是在 TCP 头部中设置，作用是告诉 TCP 协议应该把报文发给哪个进程。

由于 TCP 连接是通过四元组来唯一确定的，所以理论上，一个只有单一 IP 地址的服务器，在某个本地端口上监听时，可以建立的最大 TCP 连接数为：`2^32(客户端 IP 数) * 2^16(客户端端口数) = 2^48`。

当然，服务端最大并发的 TCP 连接数远不能达到这个理论上限，其数量会受到以下因素的影响：

* **内存限制**：每个 TCP 连接都要占用一定的内存，操作系统的内存是有限的，无法支撑如此多的 TCP 连接；

* **文件描述符限制**：每个 TCP 连接都是一个文件，如果文件描述符被占满了就会发生`Too many open files`的错误。Linux 对可打开的文件描述符的数量分别做了三个层级的限制：

    - **系统级**：当前系统可打开的最大数量，通过`cat /proc/sys/fs/file-max`查看；
    - **用户级**：单个用户可打开的最大数量，通过`cat /etc/security/limits.conf`查看；
    - **进程级**：单个进程可打开的最大数量，通过`cat /proc/sys/fs/nr_open`查看。

### 5. TCP 头格式有哪些

TCP 头的格式中包含很多内容，如：源端口号、目标端口号、序列号、确认应答号以及一些标识等，其结构如下图所示；

![](https://cnd.qiniu.lin07ux.cn/markdown/1680168740-06bf98eb74bc8429d80c9d9697008b01.png)

其中：

* **序列号**：在建立 TCP 连接时由计算机生成的随机数作为其初始值，通过 SYN 包传给接收端。每发送一次数据，序列号值就累加一次该次「发送数据字节数」的大小。**用来解决网络包乱序问题**。

* **确认应答号**：指下一次「期望」收到的数据的序列号，发送端收到这个确认应答号以后就可以认为在这个序号之前的数据都已经被正常接收了。**用来解决丢包的问题**。

* **控制位**：

    - `ACK`：为 1 时，「确认应答号」的字段变为有效。TCP 规定除了最初建立连接时的 SYN 包之外，该位必须设置为 1；
    - `RST`：为 1 时表示 TCP 连接中出现异常，必须强制断开连接；
    - `SYN`：为 1 时表示希望建立连接，并在其「序列号」的字段进行序列号初始值的设定；
    - `FIN`：为 1 时表示今后本端不会再有数据发送，希望断开连接。当通信结束希望断开连接时，通信双方的主机之间就可以相互交换`FIN`位为 1 的 TCP 段。


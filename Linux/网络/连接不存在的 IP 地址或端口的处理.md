### 1. 用 TCP 连接一个不存在的 IP 地址会发生什么？

这里需要区分两种情况：发起 TCP 连接的客户端 IP 地址和被连接的 IP 地址是否属于同一个局域网。

**同一个局域网**

在同一个局域网的时候，客户端将无法发出 SYN 报文，主要卡在数据链路层。

在局域网下，客户端的内核在发起 TCP 连接之前是需要通过 ARP 请求来寻找这个目标 IP 地址对应的 MAC 地址。但是由于这个目标 IP 不存在，所以将无法得到对端的响应，也就无法拿到目标设备的 MAC 地址，这样就没有办法组装 MAC 头信息，所以 SYN 报文无法发送出去。

**不在一个局域网**

目标 IP 地址和客户端 IP 地址不在同一个局域网（网络号不同）的时候，会发生 SYN 超时重传，最终出现连接超时。

因为不在客户端 IP 和目标 IP 不在同一个局域网，所以客户端会通过其路由表判断出，下一步是要将网络报文发送给它的网关设备，所以此时客户端的 SYN 报文就已经发出去了。

> 这个过程中会通过 ARP 请求获取到网关（路由器）设备的 MAC 地址，然后数据链路层将 SYN 报文组装上网关设备的 MAC 地址发送给网关。

网关设备接收到客户端的 SYN 报文后，会继续通过路由表判断，发送给下一个网关，直到最终的目标网络和目标设备。

但是由于目标 IP 不存在，所以没有目标设备会最终接收该 SYN 报文并对其进行确认。客户端在等待一段时间后，一直没有收到 SYN 报文的确认报文，就会触发超时重发，直到达到最大的重发次数，触发连接超时，最终释放该连接。

### 2. 用 TCP 连接一个 IP 存在但不存在的端口会发生什么？

目标 IP 地址存在的时候，就会有对应的设备接收并处理 SYN 报文，所以此时客户端是能正常的发出 SYN 报文的。

但是由于目标设备收到 SYN 报文后，发现并没有进程监听这个端口号，目标设备的内核就会发回 RST 报文关闭该连接。

客户端收到对应的 RST 报文后也会释放连接。

### 3. 用 UDP 连接一个 IP 存在但不存在的端口会发生什么？

在目标设备上，内核在发现端口没有进程在监听的时候，数据包将不会进入到传输层（UDP/TCP）就被丢弃了。而且网络层在没有进程监听 UDP 这个端口的时候，会向客户端发回一个目标端口不可达的 ICMP 报文，该报文中会包含原数据包的前 8 个字节的内容。

也就是说，UPD 不会像 TCP 那样通过目标设备发送 RST 报文来关闭连接，而是通过 ICMP 报文来通知客户端端口不可达。

> 转摘：[字节面试：连接一个不存在的 IP 地址，会发生什么？](https://mp.weixin.qq.com/s/yLp6Z_00TsAwagbx_lEPXA)


> 转摘：[Linux tcpdump命令详解](https://www.jellythink.com/archives/478)

`tcpdump`是一款强大的网络抓包工具，运行在 Linux 平台上。

### 1. 选项

tcpdump 命令有很多选项，但是很大一部分并不常用，以下是常用的部分选项：

* `-s <number>` tcpdump 默认只会截取前 96 字节的内容，要想截取所有的报文内容，就需要使用这个选项，其中 number 是需要截取的报文字节数，如果是 0 的话，表示截取报文全部内容；
* `-c number` 表示截取 number 个报文，然后结束；
* `-nn` 表示不解析域名，直接显示 IP；
* `-X` 同时使用 hex 和 ascii 显示报文内容；
* `-A` 只使用 ascii 打印报文的全部数据，不要和`-X`选项一起使用。
* `-S` 显示绝对的序列号（sequence number），而不是相对编号；
* `-i` 指定监听的网卡，如果为`-i any`则表示监听所有的网卡；
* `-v`、`-vv`、`-vvv` 显示更多的详细信息；
* `-w` 将监听到的数据包写入文件中保存，而并不分析和打印出来；

### 2. 过滤器

在服务器上的网络报文是异常的多，很多时候只关注和具体问题有关的数据报文，而这些有用的报文只占到很小的一部分，为了不在报文的海洋里迷失，就需要了解 tcpdump 提供的灵活而且功能强大的过滤器。

过滤器可以简单地分为三类：`type`、`dir`和`proto`：

* `type` 区分过滤报文源类型，主要由`host`主机报文、`net`网段报文和`port`指定端口的报文组成；
* `dir` 过滤报文的源地址和目的地址，主要包括`src`源地址和`dst`目的地址；
* `proto` 过滤报文的协议类型，支持`tcp`、`udp`和`icmp`等；使用的时候可以省略`proto`关键字。

过滤器不仅可以单独使用，也可以组合使用。组合的时候，可以使用“与”（`and`、`&&`）、“或”（`or`、`||`）和“非”（`not`、`!`）逻辑进行连接。

### 3. 实例

* `sudo tcpdump -nSA port 80` 截取 HTTP 请求
* `tcpdump -i eth1` 监视指定网络接口的数据包
* `tcpdump host 210.27.48.3` 截获 210.27.48.3 主机收到的和发出的所有数据包
* `tcpdump host 210.27.48.4 and (210.27.48.5 or 210.27.48.6)` 截获 210.27.48.3 主机和 210.27.48.5 或者 210.27.48.6 主机进行通信的所有数据包
* `tcpdump net 192.168.1.0/24` 截获 192.168.1.0/24 整个网络的数据包
* `tcpdump -i eth0 src host 210.27.48.3` 监视 eth0 网卡上源地址是 210.27.48.3 的所有网络包
* `tcpdump -i eth0 dst host 210.27.48.3` 监视 eth0 网卡上目的地址是 210.27.48.3 的所有网络包
* `tcpdump tcp port 23 and host 210.27.48.3` 获取主机 210.27.48.3 上端口为 23 的应用发出和接收的所有 TCP 协议包
* `tcpdump udp port 123` 获取本机 123 端口发出和接收的所有 UDP 协议包
* `tcpdump src host 10.126.1.222 and dst net 10.126.1.0/24` 截获源主地址为 10.126.1.222，目的地址是 10.126.1.0/24 整个网络
* `tcpdump -i eth0 -s0 -G 60 -Z root -w %Y_%m%d_%H%M_%S.pcap` 抓取报文后按照指定时间间隔保存；`-G`选项后面接时间，单位为秒；上述命令就是每隔 60 秒生存一个文件
* `tcpdump -i eth0 -s0 -C 1 -Z root -w eth0Packet.pcap` 抓取报文后按照指定报文大小保存；`-C`选项后接文件大小，单位为 MB；上述命令就是每抓包文件达到 1MB 时就使用一个新的文件保存新抓的报文 




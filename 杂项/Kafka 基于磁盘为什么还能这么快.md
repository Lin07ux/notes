> 转摘：[基于磁盘的Kafka为什么这么快](https://mp.weixin.qq.com/s/Hy3npWsrJg6w9gvgkRD89Q)

Kafka 虽然是基于磁盘做的数据存储，但却具有高性能、高吞吐、低延时的特点，其吞吐量动辄几万、几十上百万，基本原因在于它合理利用了磁盘读写特性和系统功能，具体来说，有如下几个特点。

### 1. 顺序读写

磁盘读写速度并非总是很慢！不管是内存还是磁盘，快或慢关键在于寻址的方式。

磁盘和内存的操作都分为顺序读写与随机读写。基于磁盘的随机读写确实很慢，但磁盘的顺序读写性能却很高，一般而言要高出磁盘随机读写三个数量级，一些情况下磁盘顺序读写性能甚至要高于内存随机读写。

下面是著名学术期刊 ACM Queue 上的一张性能对比图：

![](http://cnd.qiniu.lin07ux.cn/markdown/1558793527033.png)

磁盘的顺序读写是磁盘使用模式中最有规律的，并且操作系统也对这种模式做了大量优化，Kafka 就是使用了磁盘顺序读写来提升的性能。Kafka 的 message 是不断追加到本地磁盘文件末尾的，而不是随机的写入，这使得 Kafka 写入吞吐量得到了显著提升。

### 2. Page Cache

为了优化读写性能，Kafka 利用了操作系统本身的 Page Cache，也就是利用操作系统自身的内存而不是 JVM 空间内存。这样做的好处有： 

* 避免 Object 消耗：如果是使用 Java 堆，Java 对象的内存消耗比较大，通常是所存储数据的两倍甚至更多。
* 避免 GC 问题：随着 JVM中 数据不断增多，垃圾回收将会变得复杂与缓慢，使用系统缓存就不会存在 GC 问题。

相比于使用 JVM 或 in-memory cache 等数据结构，利用操作系统的 Page Cache 更加简单可靠。首先，操作系统层面的缓存利用率会更高，因为存储的都是紧凑的字节结构而不是独立的对象。其次，操作系统本身也对于 Page Cache 做了大量优化，提供了 write-behind、read-ahead 以及 flush 等多种机制。再者，即使服务进程重启，系统缓存依然不会消失，避免了 in-process cache 重建缓存的过程。

通过操作系统的 Page Cache，Kafka 的读写操作基本上是基于内存的，读写速度得到了极大的提升。

### 3. 零拷贝

数据从文件发送到 socket 网络连接中的常规传输路径： 

1. 操作系统从磁盘读取数据到内核空间(kernel space)的 Page Cache；
2. 应用程序读取 Page Cache 的数据到用户空间(user space)的缓冲区；
3. 应用程序将用户空间缓冲区的数据写回内核空间到 socket 缓冲区(socket buffer)；
4. 操作系统将数据从 socket 缓冲区复制到网络发送的 NIC 缓冲区。

可以看到，整个过程包含 4 次 copy 操作和 2 次系统上下文切换，性能其实非常低效。

Linux 操作系统的"零拷贝"机制使用了 sendfile 方法，允许操作系统将数据从 Page Cache 直接发送到网络，只需要最后一步的 copy 操作将数据复制到 NIC 缓冲区，这样避免重新复制数据 。示意图如下：

![](http://cnd.qiniu.lin07ux.cn/markdown/1558793563987.png)

通过这种"零拷贝"的机制，Page Cache 结合 sendfile 方法，Kafka 消费端的性能也大幅提升。这也是为什么有时候消费端在不断消费数据时，并没有看到磁盘 io 比较高，此刻正是操作系统缓存在提供数据。

### 4. 分区分段

Kafka 的 message 是按 topic 分类存储的，topic 中的数据又是按照一个一个的 partition 即分区存储到不同 broker 节点。每个 partition 对应了操作系统上的一个文件夹，partition 实际上又是按照 segment 分段存储的。这也非常符合分布式系统分区分桶的设计思想。 

通过这种分区分段的设计，Kafka 的 message 消息实际上是分布式存储在一个一个小的 segment 中的，每次文件操作也是直接操作的 segment。为了进一步的查询优化，Kafka 又默认为分段后的数据文件建立了索引文件，就是文件系统上的`.index`文件。

这种分区分段+索引的设计，不仅提升了数据读取的效率，同时也提高了数据操作的并行度。

### 5. 总结

总结起来，Kafka 采用顺序读写、Page Cache、零拷贝以及分区分段等这些设计，再加上在索引方面做的优化，另外 Kafka 数据读写也是批量的而不是单条的，使得 Kafka 具有了高性能、高吞吐、低延时的特点。这样，Kafka 提供大容量的磁盘存储也变成了一种优点。






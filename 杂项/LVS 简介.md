> 转摘：[LVS工作模式详解](https://mp.weixin.qq.com/s?__biz=Mzg2ODI5OTI2OQ==&mid=2247483929&idx=1&sn=9d74577c57cfe042c59c71e00b3de70d)

LVS 是运维界最常见的 4 层负载均衡工具，本文主要讲解 LVS 常见的两种工作模式：NAT 和 DR。

## 一、LVS 介绍

### 1.1 名词解释

* CIP: 发起请求的客户端 IP
* VIP: 虚拟 IP，LVS 上负责响应请求的 IP 地址
* RealServer: 后端提供服务的服务器
* Io 网卡: 本地回环网卡
* 四元组: 源端口、源 IP、目的端口、目的 IP

### 1.2 LVS DR 模式

使用 DR 模式时，需要满足如下一些条件：

* LVS 和 RealServer 需要在同一个网段
* RealServer 需要在本地网卡上配置 VIP

工作流程：

1. CIP 随机开启一个大于 1024 的端口访问 VIP 的 80 端口
2. 请求通过网络到达 LVS 服务器所在的交换机，交换机发现目的 IP 是到 VIP 的请求
3. 交换机发送 ARP 请求询问 VIP 对应的 MAC 地址
4. 只有 LVS 服务器响应该请求，因为：LVS 服务器上配置了 VIP 的地址，而 RealServer 服务器上配置的地址为回环地址，不响应交换机的广播
5. 交换机将请求转发给 LVS，并缓存 ARP 记录
6. LVS 拿到请求之后，将数据包中的 MAC 地址修改为 RealServer 的地址，并回传给交换机
7. 交换机将请求发送给对应的 RealServer
8. RealServer 收到请求后，检查确认 Mac 地址和 IP 地址是否正确（VIP配置在lo上的原因，如果不配置，改数据包将会被丢弃），正确则接受并处理请求
9. RealServer 将处理后的结果直接返回给 CIP

### 1.3 LVS NAT 模式

LVS 在 NAT 模式下工作时，没有特殊的前置条件要求。

工作流程中的前五步和 DR 模式下相同，后面就出现不同的操作了：

1. CIP 随机开启一个大于 1024 的端口访问 VIP 的 80 端口
2. 请求通过网络到达 LVS 服务器所在的交换机，交换机发现目的 IP 是到 VIP 的请求
3. 交换机发送 ARP 请求询问 VIP 对应的 MAC 地址
4. 只有 LVS 服务器响应该请求，因为：LVS 服务器上配置了 VIP 的地址，而 RealServer 服务器上配置的地址为回环地址，不响应交换机的广播
5. 交换机将请求转发给 LVS，并缓存 ARP 记录
6. LVS 拿到请求后，将数据包的四元信息进行修改后发给交换机：
    * 源 IP 和端口改为 LVS 的 IP 和端口
    * 目的 IP 和端口改为 RealServer 的 IP 和端口
7. 交换机将请求转发给对饮的 RealServer
8. RealServer 收到请求后进行处理，并将处理结果返回给 LVS
9. LVS 将数据包中的四元组信息重新修改为 CIP 的相关信息后，回应给客户端

## 二、常见问题

### 2.1 LVS NAT 和 DR 模式的区别是什么？

1. 修改的内容不同，DR 修改的是 MAC 地址，NAT 修改的是 IP、端口
2. 修改次数不同，DR 只需要修改一次，NAT 需要修改两次
3. 响应流量 DR 模式无需经过 LVS，NAT 需要
4. DR 模式要求在同一个网段，NAT 不需要

### 2.2 LVS 负载均衡和 Nginx 负载均衡的区别是什么？

网络层次上：LVS 属于四层，NGINX 属于七层。

LVS 能承载的压力要比 Nginx 强很多，但 Nginx 的功能更加丰富，可配置各种规则对 HTTP 请求进行分流。

所以一般来说大家都是两台 LVS 做 keepalive，后端挂载多个 Nginx 负载均衡器来承载流量，然后才是真正响应请求的服务器例如 Tomcat 等。

### 2.3 如果单个 LVS 也无法承载巨大的网络流量，有哪些优化的思路？

1. 使用 CDN 通过缓存的方式减轻网站的压力
2. 通过智能 DNS 的方式将流量转发到多个 LVS 上（本质上与 CDN 方案类似）
3. 通过交换机 BGP 的方式

### 2.4 如果你来优化 LVS 还有哪些改进项？

NAT 模式：

1. 在 TCP 三次握手时，LVS 先与客户端建立完成链接后，在将流量转发至 RS。
2. 在 LVS 层添加攻击防护能力。
2. TCP 链接复用，如果流量过大，那需要考虑的是 TCP 握手带来的性能损耗，如果 LVS 与 RS 保持 keepalive 那可以大大减少延迟时间。


通常情况下，对于公开文件的下载，一般直接通过 web 服务器就可以完成，而且 web 服务器也会自带文件断点续传的功能。而对于私有、动态文件来说，直接通过 Web 服务器来提供下载就无法满足需求了。这时，就需要在编写后台脚本程序时，加入对断点续传的支持。

下面就介绍通过 PHP 来实现断点续传功能。

### 原理

Http 协议规定了如何传输某个资源的一部分，而不是全部。比如，有一个文件的大小是 1000 字节，浏览器可以只请求该文件的前 300 个字节，或者只请求第 500 到第 1000 个字节。通过这种方式，就可以不必在一次请求中传输某个资源的全部内容，而是发起多次请求，每次仅请求其中的一部分内容。等所有这些请求都返回之后，再把得到的内容一块一块的拼接起来得到完整的资源。

实现断点续传就是要利用 http 协议的上述特性。当用户暂停下载的时候，浏览器会记录已经下载到什么位置，当用户在未来某一时间恢复下载时，就可以从上次暂停的位置继续下载，而不必从头开始。

### 实现

由于部分传输不是强制的，服务器可以支持也可以不支持，所以，我们需要在程序中告诉浏览器，它请求的资源是否支持部分传输。这可以通过设置 HTTP 的`Accept-Ranges`响应头信息来实现。PHP 代码如下：

```PHP
header('Accept-Ranges: bytes');
```

这段代码告诉浏览器，该资源支持以字节为单位的部分传输。这个响应头需要附加在支持部分传输的所有资源上。

当接受到一个请求时，我们需要从浏览器的请求中提取浏览器具体是在请求资源的哪一个部分。这个信息是通过`Range`请求头来传递的。在 PHP 中，它被存储在`$_SERVER['HTTP_RANGE']`中。我们需要检查这个变量是否定义了，如果定义了，则使用该值，否则，就将 range 设为整个资源。

```PHP
$range = "0-". ($content_length-1);

if(isset($_SERVER['HTTP_RANGE'])){
    $range = $_SERVER['HTTP_RANGE'];
}
```

接下来，就需要分析`$range`的值，来决定返回资源的哪一部分内容。

这里需要注意，得到一个 Range 之后，你需要对它的取值进行检验，包括：

1. 开始位置非负
2. 结束位置需要大于开始位置
3. 开始位置需要小于文件长度减一 (因为这里的位置索引是从 0 开始的)
4. 若结束位置大于文件长度减一，则需要把它的值设置为文件长度减一

如果 Range 的取值不合法，则需要终止程序并告知浏览器：

```PHP
header('HTTP/1.1 416 Requested Range Not Satisfiable');
```

校验了 Range 的取值，并得到了`$start`和`$end`两个变量，分别表示开始位置和结束位置，接下来要做的就是把文件的对应部分的内容发送给浏览器。不过要注意的是，这里涉及到需要发送多个 HTTP 响应头信息，具体如下：

```PHP
header('HTTP/1.1 206 Partial Content');
header('Accept-Ranges: bytes');
header("Content-Range: bytes $start-$end/$filesize");

$length = $end - $start + 1;
header("Content-Length: $length");

/* 输出文件的指定部分 */
```

这里的`$length`需要注意一下，它的取值是本次传输的内容的长度，而不是整个文件的长度。另外需要注意的一点是，这里的 HTTP 状态码是 206，不是 200。




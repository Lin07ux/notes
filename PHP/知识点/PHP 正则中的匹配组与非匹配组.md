> 转摘：[PHP正则中的捕获组与非捕获组](https://www.cnblogs.com/zhenbianshu/p/4941964.html)

PHP 中的正则表达式也支持捕获组的概念，通过捕获组能够更好的实现对正则提取字符串的操作。

### 0. preg_match()

在了解 PHP 中的正则捕获组的概念前，先了解下`preg_match()`函数。该函数用于使用正则表达式获取字符串中的匹配子字符，签名如下：

```
int preg_match ( string $pattern , string $subject [, array &$matches [, int $flags = 0 [, int $offset = 0 ]]] )
```

这里：

* `$pattern` 是正则匹配模式
* `$string` 是要匹配的字符串
* `&$match` 是一个数组(`&`表示匹配出来的结果会被写入`$match`中)
* `$flags` 是一个标识符，指示是否对每一个出现的匹配返回时附加字符串偏移量(相对于目标字符串)，
* `$offset` 用于制定从目标字符串的某个位置开始进行正则搜索匹配(单位是字节)。

前两个参数都是必须提供的，后面的三个参数则是可选的。

### 1. 什么是捕获组

捕获组是指正则匹配表达式中通过`()`括号包含的正则在目标字符串中匹配到的内容。

比如对于如下的正则匹配：

```php
$mode = '/a=(\d+)b=(\d+)c=(\d+)/';
$str = '**a=4b=98c=56**';
$res = preg_match($mode, $str, $match);

var_dump($match)
```

输出结果类似如下：

```
array (size=4)

  0 => string 'a=4b=98c=56' (length=11)

  1 => string '4' (length=1)

  2 => string '98' (length=2)

  3 => string '56' (length=2)
```

可以看到，对于每一对括号中设置的正则模式，都会在匹配的结果中对应一个匹配结果。

默认情况下，PHP 会为每个捕获组进行编号，从 1 开始。至于为什么会从 1 开始，是因为 PHP 把匹配到的完整字符串编号为 0。

如果有多个括号和嵌套括号，将会按**左边括号出现的顺序来进行编号**。如按下图中的匹配模式匹配时，捕获组的 1、2、3 号分别是红绿蓝：

![](http://cnd.qiniu.lin07ux.cn/markdown/1571490819024.png)

### 2. 捕获组的忽略

通过在匹配组中的模式前添加`?:`可以阻止 PHP 为该捕获组进行编号。

比如，将前面例子中的模式修改为如下：

```php
$mode = '/a=(\d+)b=(?:\d+)c=(\d+)/';
```

这里将原本的第二个捕获组的自动编号阻止了。此时，匹配的结果就变成如下了：

```
array (size=3)

  0 => string 'a=4b=98c=56' (length=11)

  1 => string '4' (length=1)

  2 => string '56' (length=2)
```

可以看到，捕获组只有两个(第一个是全部匹配结果)，而原先的第二个捕获组的结果 98 没有了。

### 3. 捕获组命名

还可以为捕获组定义一个特定的名称。命名子组可以接受接受`(?<name>)`、`(?'name')`、`(?P<name>)`语法。

例如，将正则模式改成如下：

```php
$mode = '/a=(\d+)b=(?P<second>\d+)c=(\d+)/';
```

这里为第二个捕获组设置了一个`second`的名称，那么最终捕获的结果就类似如下：

```
array (size=5)

  0 => string 'a=4b=98c=56' (length=11)

  1 => string '4' (length=1)

  'second' => string '98' (length=2)

  2 => string '98' (length=2)

  3 => string '56' (length=2)
```

可以看到，最终的结果中，在保留索引数组的同时，增加了一个关联数组项，其`key`值为设置的捕获组的名称。

### 4. 捕获组的反向引用

除了在最终的匹配结果中看到各个捕获组内容外，还可以在`preg_replace()`方法的替换中使用。此时可以使用`\n`或`$n`来引用第 n 个捕获组。

比如：

```php
$mode = '/a=(\d+)b=(\d+)c=(\d+)';
$str = '**a=4b=98c=56**';
$rp = '\1/$2/\3/';

echo preg_match($mode, $rp, $str); // **4/98/56/**
```

这里，替换字符串使用的`\1/$2/\3/`，其中`\1`、`$2`、`\3`分别表示第一、第二和第三个捕获组，也就是分别表示`4`、`98`和`56`，所以结果就是`**4/98/56/**`。

### 5. 非捕获组

正则表达式中，并非所有的小括号都会对应捕获组，而是表示前后的某种条件，其中的正则模式不会提现在最终的结果中。比如以下的四种情况：

* `(?=xxx)` 匹配**后面是** xxx 的情况
* `(?<=xxx)` 匹配**前面是** xxx 的情况
* `(?!=xxx)` 匹配**后面不是** xxx 的情况
* `(?<!=xxx)` 匹配**前面不是** xxx 的情况

比如：

```php
$str = 'ab36abc8eg';

// (?=xxx) 的情况
$mode = '/\d(?=abc)/';
preg_match($mode, $str, $match); // $match 的值为 [0 => "6"]

// (?<=xxx) 的模式
$mode = '/(?<=abc)\d/';
preg_match($mode, $str, $match); // $match 的值为 [0 => "8"]

$mode = '/\d(?!=abc)/g';
preg_match($mode, $str, $match); // $match 的值为 [0 => "3"]

$mode = '/(?<!=abc)\d/';
preg_match($mode, $str, $match); // $match 的值为 [0 => "3"]
```



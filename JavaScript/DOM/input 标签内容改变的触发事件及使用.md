> 转摘：[说一说限制字数的输入框踩的坑](https://segmentfault.com/a/1190000006259649)

### 1、三种事件的区别

1. `onchange`事件，在内容改变（两次内容有可能相等）且失去焦点时触发。

2. `oninput`事件是 IE 之外的大多数浏览器支持的事件，只在 value 改变时实时触发，但是通过 js 改变 value 时不会触发；要通过`addEventListener()`来注册。

3. `onpropertychange`事件是 IE 专有。是实时触发，每增加或删除一个字符就会触发，通过 js 改变也会触发该事件，而且是任何属性改变都会触发。注册方法与一般事件相同。
    
4. `oninput`失效的情况：当脚本中改变 value 时，不会触发；从浏览器的自动下拉提示中选取时，不会触发。

5. `onpropertychange`失效的情况：当 input 设置为`disable=true`后，不会触发。

### 2. 限制字数的输入框的坑

实时监测输入框内容长度时，可以考虑使用`oninput`事件，好处有2个：

* 当用户通过右键复制改变输入框内容时，可以监听到；
* 只有在输入框内容发生变化时才会触发此事件，比如用户按下方向键、`control`/`shift`等这些控制字符键时此事件是不会触发的。

此时，当你输入英文字符或者数字时效果完美，甚至在你`正常输入中文`(一个个中文输入)时也效果完美。但当你`非正常输入中文`(词组或句子输入)时就出现 bug 了：

![输入中文的 bug](<http://cnd.qiniu.lin07ux.cn/markdown/1471265340164.png)

可以看到，在这种中文输入方式下，其实用户还没有输入他想输入的中文，只是输入了几个拼音，但`input`事件被触发了，而且监听到的输入框`value`居然是`d'd'd`，不单单是拼音字符，还包括了分隔的点。假如输入框内容长度被限制为不超过 5，那么在截图这种情况下，就会提示用户字符长度超过限制！这样的交互效果当然不是想要的。

`keydown`、`keyup`都会遇到和`input`一样的问题，但`keypress`没有这个问题，因为在中文输入状态下，`keypress`不会触发：**不单是你输入拼音的过程中不会触发，等你选中所要输入的中文如“对对对”后也不会触发**。那么当输入“对对对”后虽然超过了字符限制但无法给出字符长度超过限制的提示了。而且这几个事件的是无法监听右键复制而来的输入内容的。

那就只有一个降级的方法：输入框失去焦点时（即`blur`），或者用户输入回车键时才进行内容长度的检测。当然如果发现输入框内容超过限制，要将光标停留在输入框内，方便用户进行修改。

### 3. 输入框中检测回车键

在表单交互中使用回车键来直接触发提交表单的事件，是一个很常见的方式，但其中要小心的坑是：**中文输入法下按回车键来输入英文字符**。

在使用中文输入法的时候，在输入中文的状态下，如果我们不想切换到英文状态下而直接输入英文，可以在打出一些字母之后，通过按下回车键来输入这些英文字母。在这种情况下，用户虽然输入了回车键，但用户按下回车键只是想在中文输入法下输入英文字符而已，这个回车键并不是我们想要监听的回车键。那么怎么排除这种情况下的回车键呢？

一般来说监听回车键我们会用`keydown`事件或者`keyup`事件，实现代码如下所示。

```javascript
//方法一：使用 keydown 事件
input.onkeydown = function(e){
  if(e.keyCode == 13){
    //用户输入的是回车键
    //做相关操作
  }
}
//方法二：使用 keyup 事件
input.onkeyup = function(e){
  if(e.keyCode == 13){
    //用户输入的是回车键
    //做相关操作
  }
}
```

经过试验发现：使用`keydown`是可以成功过滤的，但使用`keyup`不能。这是因为：

* 在`keydown`事件中：中文输入法状态下输入的回车键，检测的`keyCode`为`229`而不是`13`；单纯输入一个回车时，`keyCode`才是`13`。
* 在`keyup`事件中：中文输入法状态下输入的回车键，检测的`keyCode`是`13`；单纯输入一个回车时，`keyCode`也是`13`。





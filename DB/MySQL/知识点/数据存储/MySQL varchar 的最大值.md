> 转摘：
> 
> 1. [面试官：MySQL 中 varchar(n) 中 n 最大取值为多少？](https://mp.weixin.qq.com/s/_2sOr9YRW4_f_45X6ZXrIw)
> 2. [字节一面，问的有点细](https://mp.weixin.qq.com/s/sqW51yqeAXcDs9r84UFP7A)

`varchar(n)`中的 n 代表的是最多存储的字符数量，那么 n 最大能设置为多少呢？

在 InnoDB 存储引擎中，使用 Compact 行格式时，这个问题需要考虑两个因素：

* 行格式中*变长字段长度列表*最大能表示多少字节？知道了这个才能知道一行数据最大能存储多少字节的数据。
* 数据库表的字符集，确定了这个，才能知道 1 个字符占用多少字节。

### 1. 变长字段最大表示的字节数

行格式中，变长字段长度列表有时候是占用 1 个字节，有时候是占用 2 个字节：

* 如果变长字段允许存储的最大字节数小于等于 255 字节，每列的变长字段长度就占用 1 个字节；
* 如果变长字段允许存储的最大字节数大于 255 字节，每列的变长字段长度就占用 2 个字节。

也就是说，一个列对应的变长字段长度占用的字节数不会超过 2 个字节，那么该列对应的最大长度就是 65535 字节。

如果字符集为 ASCII，1 个字符占用 1 个字节，那么`varchar(n)`中的 n 理论上就能取到最大值 65535。

### 2. 一行数据最大长度的组成

定义一个只有一列的表，且其列类型为`varchar(65535)`，字符集为 ASCII：

```sql
CREATE TABLE test ( 
  `name` VARCHAR(65535)  NULL
) ENGINE = InnoDB DEFAULT CHARACTER SET = ascii ROW_FORMAT = COMPACT;
```

但是结果报错了：

![](https://cnd.qiniu.lin07ux.cn/markdown/1670682979)

从报错信息可以知道，一行数据的最大字节数是 65535（不包含 TEXT、BLOBs 这种大对象类型），而且这个最大字节数还包含了`storage overhead`。

MySQL 规定：**除了 TEXT、BLOBs 这种大对象类型之外，其他所有的列（不包含隐藏列）、变长字段长度列表、NULL 值列表（不包含记录头信息）三者的总长度，最大不能超过 65535 字节**。

在上面的例子中，表中只定义了一个列，该列类型为`varchar(65535)`，为变长类型，而且其值可以为 NULL。由此可知：

* 变长字段长度列表占用 2 个字节；
* NULL 值列表占用 1 个字节（即便只有一个可为 NULL 的列）；
* 真实数据最大长度 = 65535 - 2 - 1 = 65532

先看下`varchar(65533)`能否创建成功：

![](https://cnd.qiniu.lin07ux.cn/markdown/1670683870)

确实不行，不过如果不允许该列为 NULL，那么其实它是能创建成功的，因为节省了 NULL 值列表占用的空间。

再换成`varchar(65532)`：

![](https://cnd.qiniu.lin07ux.cn/markdown/1670683889)

可以正常创建了。

### 3. 字符集的影响

上面的例子中，虽然`varchar(65532)`能创建成功，但采用的字符集为 ASCII。如果将字符集换成其他类型，那么其取值可能就不一样了。

如果字符集采用`UTF-8`，那么由于一个字符可能会使用 1~3 个字节，而且在计算`varchar(n)`中 n 的最大值的时候，需要按照一个字符占用的最大字节数来计算，所以可以得到 n 的最大值为：65533/3 = 21844(无 NULL 值)。

### 4. 多字段影响

如果一个表有多个字段，就要保证：所有字段的字节长度 + 变长字段长度列表所占用的字节数 + NULL 值列表占用的字节数 <= 65535。

![](https://cnd.qiniu.lin07ux.cn/markdown/1670684864)



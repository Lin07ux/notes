MySQL 是一个基于硬盘的数据库系统，其数据都会持久化到硬盘中，而且存储的时候会按照一定的方式和格式进行处理，以便能更好的提升数据查找和存储效率。

MySQL 具体的存储行为是由存储引擎层实现的，不同的存储引擎保存数据的文件也不相同。InnoDB 是 MySQL 中常用的存储引擎，也是默认的存储引擎，下面就主要以 InnoDB 存储引擎进行介绍。

### 1. 存放路径

**数据库目录**

MySQL 数据库的文件的存储路径可以由配置参数`datadir`来指定。默认情况下，在 Linux 中 MySQL 的数据存储路径为`/var/lib/mysql/`。

可以通过如下命令查看 MySQL 数据库当前的文件存放路径：

```mysql
mysql> SHOW VARIABLES LIKE 'datadir';
+---------------+-----------------+
| Variable_name | Value           |
+---------------+-----------------+
| datadir       | /var/lib/mysql/ |
+---------------+-----------------+
1 row in set (0.00 sec)
```

这表示，每一个 database 都会在`datadir`指定的路径中创建一个以该 database 的名称为名的目录，然后将表结构和表数据的文件存放在这个目录中。

**数据文件**

数据库目录下，会有三种文件

* `db.opt` 用来存储当前数据库的默认字符集和字符校验规则；
* `.frm` 存储表的元数据信息，主要包含**表结构**信息。在 MySQL 中每张表都会对应生成一个`.frm`文件，文件名称即为表名。
* `.ibd` 存储**表数据**的文件。表数据既可以存储在共享表空间文件（文件名为`ibdata1`）里，也可以存放在独占表空间文件（文件名为`表名.ibd`）。

表的数据是存在独占表空间还是共享表空间，是由参数`innodb_file_per_table`控制的，值为 1 则表示将存储的数据、索引等存储在一个独占表空间。从 MySQL 5.6.6 开始，该参数值默认为 1 了。

### 2. 表空间文件结构

在 InnoDB 存储引擎中，默认每个表的数据对应一个`.idb`文件。而这个文件中，除了会存储写入该表的原始数据外，还会生成对应的索引树结构、其他元数据等。为了更好的组织这些数据，提升读写效率，InnoDB 会对这个文件继续进行层次划分，分类管理数据。

**InnoDB 表空间中，会依次划分为段(Segment)、区(extend)、页(Page)、行(row)**，整体结构如下图所示：

![](https://cnd.qiniu.lin07ux.cn/markdown/1670465019)

### 3. 段 Segment

表空间是由各个段组成的，每个段由多个区(Extend)组成。

> 当前，段并不是由完整的区组成的，在表初创阶段，数量量很小的情况下，为了避免完整区的浪费，会将区中的一部分页直接拿来使用，作为段的一部分。

一般会分为三种段：

* **数据段**：存放 B+ 树的叶子结点的区的集合；
* **索引段**：存放 B+ 树的非叶子结点的区的集合；
* **回滚段**：存放的是回滚数据的区的集合，可以简单理解为 undo log 的存储位置。

### 4. 区 Extend

每个区(Extend)是由 64 个页组成的。如果每个页是 16KB，那么每个区的大小就是 1MB。

之所以要封装一层区，而不是直接由页来组成段，是因为：*页的空间相对较小，如果按照页来申请磁盘空间，可能会导致两个页之间在磁盘上不是连续的，在读取数据的时候就会出现随机读的问题，降低 IO 效率。*而一次申请一个区的空间，可以存储多个页，从而保证这些页在磁盘是连续的，尽量的减少随机读的影响，属于空间换时间的考虑。

### 5. 页 Page

页是 InnoDB 存储引擎磁盘管理的最小单位，每页的大小为 16KB，用于存放具体的数据记录。由于记录的大小不固定，所以每页能存储的记录数量也不同。

用页来包裹记录行，是为了使用**数据的局部性**原理来提升数据库的 IO 效率。在读写数据的时候，并不是按行记录来读写，而是一次读写一整页的数据。

页的类型有很多，常见的有**数据页**、**undo log 页**、**溢出页**等。数据表中的行记录是用数据页来管理的。

页的详细结构可以看另一篇文章：[MySQL 业结构](./MySQL%20页结构.md)。

### 6. 行 Row

数据库表中的记录都是按行(Row)进行存放的，每行记录根据不同的行格式，有不同的存储结构。而且，根据表定义和实际存放的数据的不同，每行的实际组成也可能不同。



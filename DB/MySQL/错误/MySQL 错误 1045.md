### 问题

登陆 MySQL 时，提示登录失败，拒绝登录，类似如下：

```
ERROR 1045 (28000): Access denied for user 'my_account'@'localhost' (using password: YES)
```

### 原因

拒绝登录是因为登录时用的账号、密码、客户端所在主机的 IP 不符合 MySQL 中的设置。

### 解决

1. 检查用户名和密码是否正确。
2. 对于新创建的用户，请确认执行了`FLUSH PRIVILEGES`语句。
3. 检查客户端所在 IP 地址是否被允许使用当前用户和密码登录。
4. 检查是否有匿名用户存在，如有，考虑删除匿名用户，或改变当前登录所用的用户、密码和主机配置。

### 更多知识

对于上面解决方法中的第 4 点，匿名用户会影响其他账号的登录，确实存在的，这是由于 MySQL 在判断登录用户时所选用的定义的优先级有关的。

MySQL 中，用户登录相关的信息存放在 user 表中，数据库服务器收到客户端连接时，首先会进行身份校验，将 User、Host、Password 字段，跟`mysql.user`表里的记录进行比较，确认是否合法账户。

这里有个问题：如果`mysql.user`表中存在多条匹配记录，该以哪条记录为准？答案是“优先级”。大致规则如下：

* 首先，MySQL 会先判断客户端的 IP 是否符合要求，如果符合要求，则选择匹配度最高的记录（IP 地址 > 通配符`%`）。
* 其次，检查 User 字段。如果有多个 User 符合条件，则选择匹配度最高的记录。匿名用户可以匹配任何用户，因此匹配度最低。
* 之后再检查密码、数据库、表等因素。

假设本地数据库有如下两个账户（Password 字段实际非明文）。

```
+------------+-----------+-----------+
| User       | Host      | Password  |
+------------+-----------+-----------+
| my_account | %         | 123       |
|            | localhost | 456       |
+------------+-----------+-----------+
```

运行如下命令，最终登录的账户，匹配的是第 2 条记录。（输入密码`123`登录失败，输入`456`登录成功。）


```shell
mysql -u my_account -p
```

为什么呢？回顾下匹配的优先级：

* 首先，检查 Host 字段。`localhost`、`%` 都符合要求。`localhost`匹配度高于`%`，因此只匹配到第 2 条记录。
* 接着，检查 User 字段。第 2 条记录是匿名账户，可匹配任意 User 值，因此，第 2 条记录符合要求。
* 然后再检查 Password 字段，结果用`123`做密码登录就失败了。

综上：**如果 MySQL 中存在匿名用户，那么就可能会导致使用正常的用户名和密码也无法登陆的情况。**





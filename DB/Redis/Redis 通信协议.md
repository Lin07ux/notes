> 转摘：[浅谈Redis通信协议](https://mp.weixin.qq.com/s/247pAmPHcbO6inbwkrVMBg)

Redis 客户端和服务器端使用的通信协议叫做 RESP(Redis Serialization Protocol)，只适用用与客户端-服务器通信，而 Redis 集群使用的是不同的协议。虽然 RESP 是特意为 Redis 设计的，但也可以用于其他软件工程。

## 一、基本

RESP 具有如下特点：

* 实现简单
* 快速解析
* 可读性强
* 二进制安全

RESP 可以序列化多种不同的数据类型，比如：整型、字符串、数组，而错误是一种特定的类型。Redis 客户端把参数用数组来表示，回复的是一种特殊的数据格式。

## 二、支持类型

RESP 协议支持的数据类型有：Simple Strings、Errors、Integers、Bulk Strings 和 Arrays。客户端以 Bulk Strings 数组的形式发送命令，服务器端返回的结果是协议支持的类型之一。

RESP 协议中，上述类型是通过首个字节区分的：

* `+`代表简单字符串（Simple Strings）
* `-`代表错误类型（Errors）
* `:`代表整型（Integers）
* `$`代表多行字符串（Bulk Strings）
* `*`代表数组（Arrays） 
此外，每一部分结束时，Redis 统一使用`\r\n`表示结束，而 Redis 中 Null 则通过一种特殊的方式用 Simple Strings 或 Arrays 类型表示。

### 2.1 简单字符串

简单字符串中不允许出现`\r`或`\n`，只能有一行。它用于以最小开销传输非二进制安全字符串，例如回复的`OK`：

```
+OK\r\n
```

### 2.2 多行字符串

如果要发送二进制安全的字符串，应该使用多行字符串。

多行字符串最大长度是 512MB，编码方式如下：

* 以`$+数字`开头，以`\r\n`结束，其中数字表示字符串的长度
* 数据都是字符串
* 结尾是`\r\n`

比如，`foobar`的编码为：

```
$6\r\nfoobar\r\n
```

空字符串表示为：

```
$0\r\n\r\n
```

多行字符串也可以用来 Null：

```
$-1\r\n
```

> 当服务器返回 Null 多行字符串时，正常客户端是不应该返回空字符串的，而是应该返回 nil 对象。

### 2.3 整型

整型数据是以`:`开头，以`\r\n`结尾的字符串。比如，下面的字符串表示整数 1000：

```
:1000\r\n
```

很多 Redis 命令都会返回整型，例如`INCR`、`LLEN`和`LASTSAVE`。返回的整数需要在 64 位有符号整数范围内，同时也可以用于表示真或假。

### 2.4 数组

RESP 数组遵循以下规则：

* 第一个字符是`*`，后面跟的十进制数字是数组元素的数量，然后跟着`\r\n`
* 每个元素都是 RESP 类型的，但可以是不同类型

比如，下面表示有 5 个元素的数组：

```
*5\r\n
:1\r\n
:2\r\n
:3\r\n
:4\r\n
$6\r\nfoobar\r\n
```

空数组表示如下：

```
*0\r\n
```

RESP 也可以使用数组类型表示 NULL：

```
*-1\r\n
```

> 这是 NULL 的另一种表示方法，通常用多行字符串的 NULL 来表示，不过由于历史原因，就保留了两种形式。比如，当`BLPOP`命令超时时，就会返回 NULL 数组。

当服务器返回 NULL 数组时，客户端应该返回 nil 对象而不是空数组。

由于数组中的元素可以是任意被 RESP 支持的类型，所以也可以是 Null，此时其通常表示数组中某个元素缺失，而不是空字符串：

```
*3\r\n
$3\r\nfoo\r\n
$-1\r\n
$3\r\nbar\r\n
```

如上示例的数组中，共有 3 个元素，其中第二个元素是 Null，此时客户端的返回结果应该是：

```
["foo", nil, "bar"]
```

### 2.5 错误

RESP 有特定的错误类型，它与简单字符串类似，只不过是把开头的`+`换成了`-`，而两者之间真正的区别是客户端将错误视为异常，而错误中的字符串只是表示错误信息。类似如下：

```
"-Error message\r\n"
```

当客户端收到错误信息时，通常会抛出一个异常。

在错误的信息中，从第一个字符`-`之后，到第一个空格或新的一行之间的字符串表示*错误类型*。这只是 Redis 的一种约定，并不是 RESP 的错误格式。比如：

```
-ERR unknown command 'foobar'
-WRONGTYPE Operation against a key holding the wrong kind of value
```

这里第一行的错误是`ERR`普通异常，第二行的错误是`WRONGTYPE`客户端试图对错误的数据类型执行操作异常。



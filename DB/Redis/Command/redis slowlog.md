> 转摘：[一篇文章快速搞懂Redis的慢查询分析](https://www.cnblogs.com/heihaozi/p/12744856.html)

Redis 可以记录执行时间较长的命令到慢查询中，这些记录对 Redis 性能调优和使用提供很大帮助。

## 一、简介

### 1.1 什么是慢查询

慢查询就是执行的比较慢的查询。Redis 命令执行过程中，会经历如下四个阶段：

1. 发送命令
2. 命令排队
3. 执行命令
4. 返回结果

在慢查询的定义中，统计比较慢的时间段指的是**执行命令**这个步骤。所以，没有慢查询并不表示客户端没有超时问题，因为可能会存在网络传输有延迟，或者前面排队的命令太多。

### 1.2 什么是慢查询日志

慢查询日志是 Redis 服务器端在命令执行前后计算每条命令的执行时长，当超过某个阈值时记录下来的日志。日志中记录了慢查询发生的时间、执行时长、具体执行的命令及参数等信息，可以用来帮助开发运维人员定位系统中存在的慢查询。

### 1.3 慢查询日志的配置

慢查询日志的记录受两个参数的影响：

* `slowlog-low-slower-than` 指定命令执行时长的阈值，执行时长超过这个阈值时就会被记录下来。单位是微妙(1s = 1000ms = 1000000us)，默认值是 10000us，也就是 1ms。如果将其设置为 0，那么将会记录每一条执行的命令的日志；如果设置为负数，则不会记录任何慢查询日志。

    在实际的生产环境中，需要根据 Redis 的并发量来调整该配置。因为 Redis 采用单线程响应命令，如果命令执行时间在 1000us 以上，那么 Redis 最多可支撑的 OPS 不到 1000。所以对于高并发的场景，Redis 的慢查询日志记录阈值建议设置为 1000us。

* `slowlog-max-len` 指定慢查询日志最多存储的条数。实际上，Redis 使用了一个列表存放慢查询日志，这个参数就是用来指定这个列表的最大长度。当一个新的命令满足满足慢查询条件时，需要被插入这个列表中。如果慢查询日志列表已经达到最大长度，最早插入的那条命令将被从列表中移出。比如，`slowlog-max-len`被设置为 10，当有第 11 条命令插入时，在列表中的第 1 条命令先被移出，然后再把第 11 条命令放入列表。

    记录慢查询时 Redis 会对长命令进行截断，不会占用大量的内容。在实际环境中，为了减缓慢查询被移出的可能和更方便的定位慢查询，可以将其长度适当调大一些，如 1000 条以上。

这两个参数可以直接在 Redis 的配置文件中进行配置：

```conf
slowlog-log-lower-than 1000
slowlog-max-len 1200
```

也可以直接在 Redis 中服务器中动态更改后，使用`config rewrite`命令写回到配置中：

```shell
config set slowlog-log-slower-than 1000
config set slowlog-max-len 1200
config rewrite
```

### 1.4 慢查询日志的结构

Redis 记录的每条慢查询日志都包含如下四部分：

* 唯一标识 ID
* 命令执行的时间戳
* 命令执行时长
* 执行的命令和参数

比如，下面获取的三条慢查询日志都记录了命令的 4 个部分的信息：

```shell
> slowlog get 3
1) 1) (integer) 6107         # ID
   2) (integer) 1516398930   # 时间戳
   3) (integer) 3109         # 执行时长
   4) 1) "config"            # 命令及参数
      2) "rewrite"
2) 1) (integer) 6106
   2) (integer) 1513701788
   3) (integer) 36004
   4) 1) "flushall"
3) 1) (integer) 6105
   2) (integer) 1508722338
   3) (integer) 20449
   4) 1) "scan"
      2) "0"
      3) "MATCH"
      4) "*comment*"
      5) "COUNT"
      6) "10000"
```

在 Redis 4.0 之后，每条记录还会增加两个可选的信息：

* 请求执行命令的客户端 IP 和 Port
* 请求执行命令的客户端的名称(如果执行了`CLIENT SETNAME`命令才会有)

比如，4.0 之后可能会展示类似如下的慢日志：

```shell
> slowlog get 1
1) 1) (integer) 6107         # ID
   2) (integer) 1516398930   # 时间戳
   3) (integer) 3109         # 执行时长
   4) 1) "config"            # 命令及参数
      2) "rewrite"
   5) "127.0.0.1:58217"      # 客户端 IP 和 Port
   6) "worker-123"           # 客户端名称
```

## 二、命令

Redis 慢查询的命令为`slowlog`，通过该命令可以对慢查询日志进行查看、清理等。

### 2.1 slowlog get 获取慢查询日志

获取慢查询日志的命令如下，可以指定获取全部或者部分慢查询的日志：

```shell
slowlog get [counts]
```

其中，参数`counts`是可选的，用来指定获取几条慢查询日志。如果不提供则默认获取全部的慢查询日志。

> 获取的慢查询日志是按照时间倒叙排列的，也就是最近的慢查询日志在最前面(顶部)。

比如，获取一条慢查询日志：

```shell
> slowlog get 1
1) 1) (integer) 6107
   2) (integer) 1616398930
   3) (integer) 3109
   4) 1) "config"
      2) "rewrite"
```

### 2.2 slowlog len 获取慢查询日志长度

可以使用如下命令获取慢查询日志的长度：

```shell
slowlog len
```

比如：

```shell
> slowlog len
(integer) 121
```

### 2.3 slowlog reset 清理慢查询日志

如果要清理慢查询日志可以使用如下的命令：

```shell
slowlog reset
```

比如：

```shell
> slowlog len
(integer) 121
> slowlog reset
OK
> slowlog len
(integer) 0
```

